---
sidebar_position: 1
---

# Authentication

N√≥i chung, authentication bao g·ªìm c√°c b∆∞·ªõc sau:

1. L·∫•y credentials t·ª´ ng∆∞·ªùi d√πng
1. G·ª≠i ch√∫ng ƒë·∫øn backend
1. L∆∞u tr·ªØ token ƒë·ªÉ th·ª±c hi·ªán c√°c authenticated requests

## C√°ch l·∫•y credentials t·ª´ ng∆∞·ªùi d√πng

Ch√∫ng t√¥i gi·∫£ ƒë·ªãnh r·∫±ng app c·ªßa b·∫°n ch·ªãu tr√°ch nhi·ªám l·∫•y credentials. N·∫øu b·∫°n c√≥ authentication qua OAuth, b·∫°n c√≥ th·ªÉ ƒë∆°n gi·∫£n t·∫°o m·ªôt login page v·ªõi link ƒë·∫øn login page c·ªßa OAuth provider v√† b·ªè qua ƒë·∫øn [b∆∞·ªõc 3](#how-to-store-the-token-for-authenticated-requests).

### Page chuy√™n d·ª•ng cho login

Th√¥ng th∆∞·ªùng, c√°c websites c√≥ c√°c pages chuy√™n d·ª•ng cho login, n∆°i b·∫°n nh·∫≠p username v√† password. C√°c pages n√†y kh√° ƒë∆°n gi·∫£n, v√¨ v·∫≠y ch√∫ng kh√¥ng y√™u c·∫ßu decomposition. Login v√† registration forms kh√° gi·ªëng nhau v·ªÅ ngo·∫°i h√¨nh, v√¨ v·∫≠y ch√∫ng th·∫≠m ch√≠ c√≥ th·ªÉ ƒë∆∞·ª£c nh√≥m v√†o m·ªôt page. T·∫°o m·ªôt slice cho login/registration page c·ªßa b·∫°n tr√™n layer Pages:

- üìÇ pages
    - üìÇ login
        - üìÇ ui
            - üìÑ LoginPage.tsx (or your framework's component file format)
            - üìÑ RegisterPage.tsx
        - üìÑ index.ts
    - other pages‚Ä¶

·ªû ƒë√¢y ch√∫ng t√¥i t·∫°o hai components v√† export c·∫£ hai trong index file c·ªßa slice. C√°c components n√†y s·∫Ω ch·ª©a forms ch·ªãu tr√°ch nhi·ªám tr√¨nh b√†y cho ng∆∞·ªùi d√πng c√°c controls d·ªÖ hi·ªÉu ƒë·ªÉ l·∫•y credentials c·ªßa h·ªç.

### Dialog cho login

N·∫øu app c·ªßa b·∫°n c√≥ dialog cho login c√≥ th·ªÉ ƒë∆∞·ª£c s·ª≠ d·ª•ng tr√™n b·∫•t k·ª≥ page n√†o, h√£y c√¢n nh·∫Øc t·∫°o dialog ƒë√≥ th√†nh m·ªôt widget. B·∫±ng c√°ch ƒë√≥, b·∫°n v·∫´n c√≥ th·ªÉ tr√°nh qu√° nhi·ªÅu decomposition, nh∆∞ng c√≥ t·ª± do t√°i s·ª≠ d·ª•ng dialog n√†y tr√™n b·∫•t k·ª≥ page n√†o.

- üìÇ widgets
    - üìÇ login-dialog
        - üìÇ ui
            - üìÑ LoginDialog.tsx
        - üìÑ index.ts
    - other widgets‚Ä¶

Ph·∫ßn c√≤n l·∫°i c·ªßa h∆∞·ªõng d·∫´n n√†y ƒë∆∞·ª£c vi·∫øt cho c√°ch ti·∫øp c·∫≠n dedicated page, nh∆∞ng c√°c nguy√™n t·∫Øc t∆∞∆°ng t·ª± √°p d·ª•ng cho dialog widget.

### Client-side validation

Thi·ªáng tho·∫£ng, ƒë·∫∑c bi·ªát l√† cho registration, vi·ªác th·ª±c hi·ªán client-side validation ƒë·ªÉ cho ng∆∞·ªùi d√πng bi·∫øt nhanh ch√≥ng r·∫±ng h·ªç ƒë√£ m·∫Øc l·ªói l√† h·ª£p l√Ω. Validation c√≥ th·ªÉ di·ªÖn ra trong segment `model` c·ªßa login page. S·ª≠ d·ª•ng m·ªôt schema validation library, v√≠ d·ª•, [Zod][ext-zod] cho JS/TS, v√† expose schema ƒë√≥ cho segment `ui`:

```ts title="pages/login/model/registration-schema.ts"
import { z } from "zod";

export const registrationData = z.object({
    email: z.string().email(),
    password: z.string().min(6),
    confirmPassword: z.string(),
}).refine((data) => data.password === data.confirmPassword, {
    message: "Passwords do not match",
    path: ["confirmPassword"],
});
```
    
Sau ƒë√≥, trong segment `ui`, b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng schema n√†y ƒë·ªÉ validate user input:

```tsx title="pages/login/ui/RegisterPage.tsx"
import { registrationData } from "../model/registration-schema";

function validate(formData: FormData) {
    const data = Object.fromEntries(formData.entries());
    try {
        registrationData.parse(data);
    } catch (error) {
        // TODO: Show error message to the user
    }
}

export function RegisterPage() {
    return (
        <form onSubmit={(e) => validate(new FormData(e.target))}>
            <label htmlFor="email">E-mail</label>
            <input id="email" name="email" required />

            <label htmlFor="password">Password (min. 6 characters)</label>
            <input id="password" name="password" type="password" required />

            <label htmlFor="confirmPassword">Confirm password</label>
            <input id="confirmPassword" name="confirmPassword" type="password" required />
        </form>
    )
}
```

## C√°ch g·ª≠i credentials ƒë·∫øn backend

T·∫°o m·ªôt function th·ª±c hi·ªán request ƒë·∫øn login endpoint c·ªßa backend. Function n√†y c√≥ th·ªÉ ƒë∆∞·ª£c g·ªçi tr·ª±c ti·∫øp trong component code s·ª≠ d·ª•ng mutation library (v√≠ d·ª• TanStack Query), ho·∫∑c c√≥ th·ªÉ ƒë∆∞·ª£c g·ªçi nh∆∞ side effect trong state manager. Nh∆∞ ƒë∆∞·ª£c gi·∫£i th√≠ch trong [h∆∞·ªõng d·∫´n cho API requests][examples-api-requests], b·∫°n c√≥ th·ªÉ ƒë·∫∑t request c·ªßa m√¨nh trong `shared/api` ho·∫∑c trong segment `api` c·ªßa login page.

### Two-factor authentication

N·∫øu app c·ªßa b·∫°n h·ªó tr·ª£ two-factor authentication (2FA), b·∫°n c√≥ th·ªÉ ph·∫£i redirect ƒë·∫øn page kh√°c n∆°i ng∆∞·ªùi d√πng c√≥ th·ªÉ nh·∫≠p one-time password. Th√¥ng th∆∞·ªùng `POST /login` request c·ªßa b·∫°n s·∫Ω tr·∫£ v·ªÅ user object v·ªõi flag ch·ªâ ra r·∫±ng ng∆∞·ªùi d√πng ƒë√£ b·∫≠t 2FA. N·∫øu flag ƒë√≥ ƒë∆∞·ª£c thi·∫øt l·∫≠p, redirect ng∆∞·ªùi d√πng ƒë·∫øn 2FA page.

V√¨ page n√†y li√™n quan r·∫•t ch·∫∑t ch·∫Ω ƒë·∫øn logging in, b·∫°n c≈©ng c√≥ th·ªÉ gi·ªØ n√≥ trong c√πng m·ªôt slice, `login` tr√™n layer Pages.

B·∫°n c≈©ng c·∫ßn m·ªôt request function kh√°c, t∆∞∆°ng t·ª± nh∆∞ `login()` m√† ch√∫ng t√¥i ƒë√£ t·∫°o ·ªü tr√™n. ƒê·∫∑t ch√∫ng c√πng nhau, ho·∫∑c trong Shared, ho·∫∑c trong segment `api` c·ªßa page `login`.

## C√°ch l∆∞u tr·ªØ token cho authenticated requests {#how-to-store-the-token-for-authenticated-requests}

B·∫•t k·ªÉ authentication scheme n√†o b·∫°n c√≥, cho d√π l√† login & password ƒë∆°n gi·∫£n, OAuth, ho·∫∑c two-factor authentication, cu·ªëi c√πng b·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c m·ªôt token. Token n√†y n√™n ƒë∆∞·ª£c l∆∞u tr·ªØ ƒë·ªÉ c√°c requests ti·∫øp theo c√≥ th·ªÉ identify ch√≠nh ch√∫ng.

L∆∞u tr·ªØ token l√Ω t∆∞·ªüng cho web app l√† **cookie** ‚Äî n√≥ kh√¥ng y√™u c·∫ßu token storage ho·∫∑c handling th·ªß c√¥ng. V√¨ v·∫≠y, cookie storage h·∫ßu nh∆∞ kh√¥ng c·∫ßn c√¢n nh·∫Øc g√¨ t·ª´ ph√≠a frontend architecture. N·∫øu frontend framework c·ªßa b·∫°n c√≥ server side (v√≠ d·ª•, [Remix][ext-remix]), th√¨ b·∫°n n√™n l∆∞u tr·ªØ server-side cookie infrastructure trong `shared/api`. C√≥ m·ªôt v√≠ d·ª• trong [ph·∫ßn Authentication c·ªßa tutorial][tutorial-authentication] v·ªÅ c√°ch th·ª±c hi·ªán ƒëi·ªÅu ƒë√≥ v·ªõi Remix.

Tuy nhi√™n, ƒë√¥i khi cookie storage kh√¥ng ph·∫£i l√† l·ª±a ch·ªçn. Trong tr∆∞·ªùng h·ª£p n√†y, b·∫°n s·∫Ω ph·∫£i l∆∞u tr·ªØ token th·ªß c√¥ng. Ngo√†i vi·ªác l∆∞u tr·ªØ token, b·∫°n c≈©ng c√≥ th·ªÉ c·∫ßn thi·∫øt l·∫≠p logic ƒë·ªÉ refresh token khi n√≥ expires. V·ªõi FSD, c√≥ nhi·ªÅu n∆°i b·∫°n c√≥ th·ªÉ l∆∞u tr·ªØ token, c≈©ng nh∆∞ nhi·ªÅu c√°ch ƒë·ªÉ l√†m cho n√≥ available cho ph·∫ßn c√≤n l·∫°i c·ªßa app.

### Trong Shared

C√°ch ti·∫øp c·∫≠n n√†y ho·∫°t ƒë·ªông t·ªët v·ªõi API client ƒë∆∞·ª£c define trong `shared/api` v√¨ token c√≥ s·∫µn m·ªôt c√°ch t·ª± do cho c√°c request functions kh√°c y√™u c·∫ßu authentication ƒë·ªÉ th√†nh c√¥ng. B·∫°n c√≥ th·ªÉ l√†m cho API client gi·ªØ state, ho·∫∑c v·ªõi reactive store ho·∫∑c ƒë∆°n gi·∫£n l√† module-level variable, v√† c·∫≠p nh·∫≠t state ƒë√≥ trong c√°c functions `login()`/`logout()` c·ªßa b·∫°n.

Automatic token refresh c√≥ th·ªÉ ƒë∆∞·ª£c implement nh∆∞ middleware trong API client ‚Äî th·ª© g√¨ ƒë√≥ c√≥ th·ªÉ th·ª±c thi m·ªói khi b·∫°n th·ª±c hi·ªán b·∫•t k·ª≥ request n√†o. N√≥ c√≥ th·ªÉ ho·∫°t ƒë·ªông nh∆∞ th·∫ø n√†y:

- Authenticate v√† l∆∞u tr·ªØ access token c≈©ng nh∆∞ refresh token
- Th·ª±c hi·ªán b·∫•t k·ª≥ request n√†o y√™u c·∫ßu authentication
- N·∫øu request th·∫•t b·∫°i v·ªõi status code ch·ªâ ra token expiration, v√† c√≥ token trong store, th·ª±c hi·ªán refresh request, l∆∞u tr·ªØ c√°c tokens m·ªõi, v√† retry request g·ªëc

M·ªôt trong nh·ªØng drawbacks c·ªßa c√°ch ti·∫øp c·∫≠n n√†y l√† logic managing v√† refreshing token kh√¥ng c√≥ m·ªôt n∆°i chuy√™n d·ª•ng. ƒêi·ªÅu n√†y c√≥ th·ªÉ ·ªïn ƒë·ªëi v·ªõi m·ªôt s·ªë apps ho·∫∑c teams, nh∆∞ng n·∫øu logic token management ph·ª©c t·∫°p h∆°n, c√≥ th·ªÉ t·ªët h∆°n l√† t√°ch bi·ªát tr√°ch nhi·ªám c·ªßa vi·ªác th·ª±c hi·ªán requests v√† managing tokens. B·∫°n c√≥ th·ªÉ l√†m ƒëi·ªÅu ƒë√≥ b·∫±ng c√°ch gi·ªØ requests v√† API client trong `shared/api`, nh∆∞ng token store v√† management logic trong `shared/auth`.

M·ªôt drawback kh√°c c·ªßa c√°ch ti·∫øp c·∫≠n n√†y l√† n·∫øu backend c·ªßa b·∫°n tr·∫£ v·ªÅ object th√¥ng tin c·ªßa current user c√πng v·ªõi token, b·∫°n ph·∫£i l∆∞u tr·ªØ ƒëi·ªÅu ƒë√≥ ·ªü ƒë√¢u ƒë√≥ ho·∫∑c b·ªè qua th√¥ng tin ƒë√≥ v√† request l·∫°i t·ª´ endpoint nh∆∞ `/me` ho·∫∑c `/users/current`.

### Trong Entities

Th√¥ng th∆∞·ªùng c√°c d·ª± √°n FSD c√≥ m·ªôt entity cho user v√†/ho·∫∑c m·ªôt entity cho current user. N√≥ th·∫≠m ch√≠ c√≥ th·ªÉ l√† c√πng m·ªôt entity cho c·∫£ hai.

:::note

**Current user** ƒë√¥i khi c≈©ng ƒë∆∞·ª£c g·ªçi l√† "viewer" ho·∫∑c "me". ƒêi·ªÅu n√†y l√† ƒë·ªÉ ph√¢n bi·ªát single authenticated user, v·ªõi permissions v√† private information, t·ª´ danh s√°ch t·∫•t c·∫£ users v·ªõi publicly accessible information.

:::

ƒê·ªÉ l∆∞u tr·ªØ token trong User entity, t·∫°o reactive store trong segment `model`. Store ƒë√≥ c√≥ th·ªÉ ch·ª©a c·∫£ token v√† user object.

V√¨ API client th∆∞·ªùng ƒë∆∞·ª£c define trong `shared/api` ho·∫∑c spread qua c√°c entities, th√°ch th·ª©c ch√≠nh c·ªßa c√°ch ti·∫øp c·∫≠n n√†y l√† l√†m cho token available cho c√°c requests kh√°c c·∫ßn n√≥ m√† kh√¥ng vi ph·∫°m [import rule tr√™n c√°c layers][import-rule-on-layers]:

> M·ªôt module (file) trong slice ch·ªâ c√≥ th·ªÉ import c√°c slices kh√°c khi ch√∫ng ƒë∆∞·ª£c ƒë·∫∑t tr√™n c√°c layers ·ªü ph√≠a d∆∞·ªõi.

C√≥ nhi·ªÅu gi·∫£i ph√°p cho th√°ch th·ª©c n√†y:

1. **Pass token th·ªß c√¥ng m·ªói l·∫ßn b·∫°n th·ª±c hi·ªán request**  
    ƒê√¢y l√† gi·∫£i ph√°p ƒë∆°n gi·∫£n nh·∫•t, nh∆∞ng n√≥ nhanh ch√≥ng tr·ªü n√™n c·ªìng k·ªÅnh, v√† n·∫øu b·∫°n kh√¥ng c√≥ type safety, d·ªÖ qu√™n. N√≥ c≈©ng kh√¥ng t∆∞∆°ng th√≠ch v·ªõi middlewares pattern cho API client trong Shared.
1. **Expose token cho to√†n b·ªô app v·ªõi context ho·∫∑c global store nh∆∞ `localStorage`**  
    Key ƒë·ªÉ retrieve token s·∫Ω ƒë∆∞·ª£c gi·ªØ trong `shared/api` ƒë·ªÉ API client c√≥ th·ªÉ truy c·∫≠p n√≥. Reactive store c·ªßa token s·∫Ω ƒë∆∞·ª£c export t·ª´ User entity, v√† context provider (n·∫øu c·∫ßn) s·∫Ω ƒë∆∞·ª£c thi·∫øt l·∫≠p tr√™n layer App. ƒêi·ªÅu n√†y cho nhi·ªÅu t·ª± do h∆°n ƒë·ªÉ thi·∫øt k·∫ø API client, tuy nhi√™n, n√≥ t·∫°o ra implicit dependency tr√™n c√°c layers cao h∆°n ƒë·ªÉ cung c·∫•p context. Khi theo c√°ch ti·∫øp c·∫≠n n√†y, h√£y c√¢n nh·∫Øc cung c·∫•p c√°c error messages h·ªØu √≠ch n·∫øu context ho·∫∑c `localStorage` kh√¥ng ƒë∆∞·ª£c thi·∫øt l·∫≠p ch√≠nh x√°c.
1. **Inject token v√†o API client m·ªói khi n√≥ thay ƒë·ªïi**  
    N·∫øu store c·ªßa b·∫°n l√† reactive, b·∫°n c√≥ th·ªÉ t·∫°o subscription s·∫Ω c·∫≠p nh·∫≠t token store c·ªßa API client m·ªói khi store trong entity thay ƒë·ªïi. ƒêi·ªÅu n√†y t∆∞∆°ng t·ª± nh∆∞ gi·∫£i ph√°p tr∆∞·ªõc ·ªü ch·ªó ch√∫ng ƒë·ªÅu t·∫°o implicit dependency tr√™n c√°c layers cao h∆°n, nh∆∞ng c√°i n√†y imperative h∆°n ("push"), trong khi c√°i tr∆∞·ªõc declarative h∆°n ("pull").

Khi b·∫°n v∆∞·ª£t qua th√°ch th·ª©c expose token ƒë∆∞·ª£c l∆∞u tr·ªØ trong model c·ªßa entity, b·∫°n c√≥ th·ªÉ encode nhi·ªÅu business logic li√™n quan ƒë·∫øn token management. V√≠ d·ª•, segment `model` c√≥ th·ªÉ ch·ª©a logic ƒë·ªÉ invalidate token sau m·ªôt kho·∫£ng th·ªùi gian nh·∫•t ƒë·ªãnh, ho·∫∑c refresh token khi n√≥ expires. ƒê·ªÉ th·ª±c s·ª± th·ª±c hi·ªán requests ƒë·∫øn backend, s·ª≠ d·ª•ng segment `api` c·ªßa User entity ho·∫∑c `shared/api`.

### Trong Pages/Widgets (kh√¥ng ƒë∆∞·ª£c khuy·∫øn ngh·ªã)

Kh√¥ng ƒë∆∞·ª£c khuy·∫øn kh√≠ch l∆∞u tr·ªØ app-wide state nh∆∞ access token trong pages ho·∫∑c widgets. Tr√°nh ƒë·∫∑t token store c·ªßa b·∫°n trong segment `model` c·ªßa login page, thay v√†o ƒë√≥ h√£y ch·ªçn t·ª´ hai gi·∫£i ph√°p ƒë·∫ßu ti√™n, Shared ho·∫∑c Entities.

## Logout v√† token invalidation

Th√¥ng th∆∞·ªùng, c√°c apps kh√¥ng c√≥ m·ªôt page ho√†n ch·ªânh cho logging out, nh∆∞ng logout functionality v·∫´n r·∫•t quan tr·ªçng. N√≥ bao g·ªìm authenticated request ƒë·∫øn backend v√† c·∫≠p nh·∫≠t token store.

N·∫øu b·∫°n l∆∞u tr·ªØ t·∫•t c·∫£ requests trong `shared/api`, h√£y gi·ªØ logout request function ·ªü ƒë√≥, g·∫ßn login function. N·∫øu kh√¥ng, h√£y c√¢n nh·∫Øc gi·ªØ logout request function g·∫ßn button k√≠ch ho·∫°t n√≥. V√≠ d·ª•, n·∫øu b·∫°n c√≥ header widget xu·∫•t hi·ªán tr√™n m·ªói page v√† ch·ª©a logout link, h√£y ƒë·∫∑t request ƒë√≥ trong segment `api` c·ªßa widget ƒë√≥.

C·∫≠p nh·∫≠t token store s·∫Ω ph·∫£i ƒë∆∞·ª£c trigger t·ª´ v·ªã tr√≠ c·ªßa logout button, nh∆∞ header widget. B·∫°n c√≥ th·ªÉ k·∫øt h·ª£p request v√† store update trong segment `model` c·ªßa widget ƒë√≥.

### Automatic logout

ƒê·ª´ng qu√™n x√¢y d·ª±ng c√°c failsafes cho khi request log out th·∫•t b·∫°i, ho·∫∑c request refresh login token th·∫•t b·∫°i. Trong c·∫£ hai tr∆∞·ªùng h·ª£p n√†y, b·∫°n n√™n clear token store. N·∫øu b·∫°n gi·ªØ token trong Entities, code n√†y c√≥ th·ªÉ ƒë∆∞·ª£c ƒë·∫∑t trong segment `model` v√¨ n√≥ l√† pure business logic. N·∫øu b·∫°n gi·ªØ token trong Shared, ƒë·∫∑t logic n√†y trong `shared/api` c√≥ th·ªÉ l√†m segment ph√¨nh to v√† pha lo√£ng m·ª•c ƒë√≠ch c·ªßa n√≥. N·∫øu b·∫°n nh·∫≠n th·∫•y r·∫±ng API segment c·ªßa m√¨nh ch·ª©a nhi·ªÅu th·ª© kh√¥ng li√™n quan, h√£y c√¢n nh·∫Øc t√°ch logic token management th√†nh segment kh√°c, v√≠ d·ª•, `shared/auth`.

[tutorial-authentication]: /docs/get-started/tutorial#authentication
[import-rule-on-layers]: /docs/reference/layers#import-rule-on-layers
[examples-api-requests]: /docs/guides/examples/api-requests
[ext-remix]: https://remix.run
[ext-zod]: https://zod.dev

