---
sidebar_position: 4
title: APIリクエストの処理
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import TranslationBanner from "@site/src/shared/ui/translation-banner/tmpl.mdx"

<TranslationBanner />

# APIリクエストの処理 {#handling-api-requests}

## 共有APIリクエスト {#shared-api-requests}

共通のAPIリクエストロジックは`shared/api`ディレクトリに配置することから始めます。これにより、アプリケーション全体でリクエストを簡単に再利用でき、プロトタイピングの高速化に役立ちます。多くのプロジェクトでは、API呼び出しに必要なのはこれだけです。

典型的なファイル構造は次のようになります。
- 📂 shared
    - 📂 api
        - 📄 client.ts
        - 📄 index.ts
        - 📂 endpoints
            - 📄 login.ts

`client.ts`ファイルは、HTTPリクエストの設定を一元化します。選択したメソッド（`fetch()`や`axios`インスタンスなど）をラップし、次のような共通の設定を処理します。

- バックエンドのベースURL
- デフォルトヘッダー（認証用など）
- データシリアライゼーション

`axios`と`fetch`の例を以下に示します。

<Tabs>

<TabItem value="axios" label="Axios">
```ts title="shared/api/client.ts"
// Example using axios
import axios from 'axios';

export const client = axios.create({
  baseURL: 'https://your-api-domain.com/api/',
  timeout: 5000,
  headers: { 'X-Custom-Header': 'my-custom-value' }
});
```
</TabItem>

<TabItem value="fetch" label="Fetch">
```ts title="shared/api/client.ts"
export const client = {
  async post(endpoint: string, body: any, options?: RequestInit) {
    const response = await fetch(`https://your-api-domain.com/api${endpoint}`, {
      method: 'POST',
      body: JSON.stringify(body),
      ...options,
      headers: {
        'Content-Type': 'application/json',
        'X-Custom-Header': 'my-custom-value',
        ...options?.headers,
      },
    });
    return response.json();
  }
  // ... other methods like put, delete, etc.
};
```
</TabItem>

</Tabs>

個々のAPIリクエスト関数は`shared/api/endpoints`に、APIエンドポイントごとにグループ化して整理します。

:::note

例をわかりやすくするために、フォームのインタラクションとバリデーションは省略しています。ZodやValibotのようなライブラリの詳細については、[Type Validation and Schemas](/docs/guides/examples/types#type-validation-schemas-and-zod)の記事を参照してください。

:::

```ts title="shared/api/endpoints/login.ts"
import { client } from '../client';

export interface LoginCredentials {
  email: string;
  password: string;
}

export function login(credentials: LoginCredentials) {
  return client.post('/login', credentials);
}
```

`shared/api`の`index.ts`ファイルを使用して、リクエスト関数をエクスポートします。

```ts title="shared/api/index.ts"
export { client } from './client'; // If you want to export the client itself
export { login } from './endpoints/login';
export type { LoginCredentials } from './endpoints/login';
```

## スライス固有のAPIリクエスト {#slice-specific-api-requests}

APIリクエストが特定のスライス（単一のページや機能など）でのみ使用され、再利用されない場合は、そのスライスのapiセグメントに配置します。これにより、スライス固有のロジックがきちんと整理されます。

- 📂 pages
    - 📂 login
        - 📄 index.ts
        - 📂 api
            - 📄 login.ts
        - 📂 ui
            - 📄 LoginPage.tsx

```ts title="pages/login/api/login.ts"
import { client } from 'shared/api';

interface LoginCredentials {
  email: string;
  password: string;
}

export function login(credentials: LoginCredentials) {
  return client.post('/login', credentials);
}
```

このリクエストがアプリケーションの他の場所で必要になる可能性は低いので、ページの公開APIで`login()`関数をエクスポートする必要はありません。

:::note

API呼び出しとレスポンスの型を`entities`レイヤーに時期尚早に配置することは避けてください。バックエンドのレスポンスは、フロントエンドのエンティティが必要とするものと異なる場合があります。`shared/api`またはスライスの`api`セグメントのAPIロジックを使用すると、データを適切に変換でき、エンティティをフロントエンドの懸念事項に集中させることができます。

:::

## クライアントジェネレーターの使用 {#client-generators}

バックエンドにOpenAPI仕様がある場合、[orval](https://orval.dev/)や[openapi-typescript](https://openapi-ts.dev/)のようなツールでAPIの型とリクエスト関数を生成できます。生成されたコードは、たとえば`shared/api/openapi`に配置します。これらの型が何であるか、そしてそれらを生成する方法を文書化するために、`README.md`を含めるようにしてください。

## サーバーステートライブラリとの統合 {#server-state-libraries}

[TanStack Query (React Query)](https://tanstack.com/query/latest)や[Pinia Colada](https://pinia-colada.esm.dev/)のようなサーバーステートライブラリを使用する場合、スライス間で型やキャッシュキーを共有する必要があるかもしれません。次のようなものには`shared`レイヤーを使用します。

- APIデータ型
- キャッシュキー
- 共通のクエリ/ミューテーションオプション
