---
title: æ•™ç¨‹
sidebar:
  order: 2
---

import { FileTree, Code } from '@astrojs/starlight/components';

## ç¬¬ä¸€éƒ¨åˆ†ã€‚ç†è®ºä¸Š

æœ¬æ•™ç¨‹å°†æ£€æŸ¥ Real World Appï¼Œä¹Ÿç§°ä¸º Conduitã€‚Conduit æ˜¯ä¸€ä¸ªåŸºæœ¬çš„ [Medium](https://medium.com/) å…‹éš† â€” å®ƒè®©æ‚¨é˜…è¯»å’Œç¼–å†™æ–‡ç« ï¼Œä»¥åŠå¯¹ä»–äººçš„æ–‡ç« è¿›è¡Œè¯„è®ºã€‚

![Conduit home page](/img/tutorial/realworld-feed-anonymous.jpg)

è¿™æ˜¯ä¸€ä¸ªç›¸å½“å°çš„åº”ç”¨ç¨‹åºï¼Œæ‰€ä»¥æˆ‘ä»¬å°†ä¿æŒç®€å•å¹¶é¿å…è¿‡åº¦åˆ†è§£ã€‚æ•´ä¸ªåº”ç”¨ç¨‹åºå¾ˆå¯èƒ½åªéœ€è¦ä¸‰ä¸ª layersï¼š**App**ã€**Pages** å’Œ **Shared**ã€‚å¦‚æœä¸æ˜¯ï¼Œæˆ‘ä»¬å°†åœ¨è¿‡ç¨‹ä¸­å¼•å…¥é¢å¤–çš„ layersã€‚å‡†å¤‡å¥½äº†å—ï¼Ÿ

### ä»åˆ—å‡ºé¡µé¢å¼€å§‹

å¦‚æœæˆ‘ä»¬æŸ¥çœ‹ä¸Šé¢çš„æˆªå›¾ï¼Œæˆ‘ä»¬å¯ä»¥è‡³å°‘å‡è®¾ä»¥ä¸‹é¡µé¢ï¼š

- ä¸»é¡µï¼ˆæ–‡ç« æµï¼‰
- ç™»å½•å’Œæ³¨å†Œ
- æ–‡ç« é˜…è¯»å™¨
- æ–‡ç« ç¼–è¾‘å™¨
- ç”¨æˆ·èµ„æ–™æŸ¥çœ‹å™¨
- ç”¨æˆ·èµ„æ–™ç¼–è¾‘å™¨ï¼ˆç”¨æˆ·è®¾ç½®ï¼‰

è¿™äº›é¡µé¢ä¸­çš„æ¯ä¸€ä¸ªéƒ½å°†æˆä¸º Pages *layer* ä¸Šçš„è‡ªå·±çš„ *slice*ã€‚å›å¿†ä¸€ä¸‹æ¦‚è§ˆä¸­çš„å†…å®¹ï¼Œslices ç®€å•æ¥è¯´å°±æ˜¯ layers å†…éƒ¨çš„æ–‡ä»¶å¤¹ï¼Œè€Œ layers ç®€å•æ¥è¯´å°±æ˜¯å…·æœ‰é¢„å®šä¹‰åç§°çš„æ–‡ä»¶å¤¹ï¼Œå¦‚ `pages`ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬çš„ Pages æ–‡ä»¶å¤¹å°†å¦‚ä¸‹æ‰€ç¤ºï¼š

<FileTree>
- pages/
  - feed/
  - sign-in/
  - article-read/
  - article-edit/
  - profile/
  - settings/
</FileTree>

Feature-Sliced Design ä¸æ— è§„åˆ™ä»£ç ç»“æ„çš„å…³é”®åŒºåˆ«æ˜¯é¡µé¢ä¸èƒ½ç›¸äº’å¼•ç”¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªé¡µé¢ä¸èƒ½ä»å¦ä¸€ä¸ªé¡µé¢å¯¼å…¥ä»£ç ã€‚è¿™æ˜¯ç”±äº **layers ä¸Šçš„å¯¼å…¥è§„åˆ™**ï¼š

*slice ä¸­çš„æ¨¡å—ï¼ˆæ–‡ä»¶ï¼‰åªèƒ½åœ¨å…¶ä»– slices ä½äºä¸¥æ ¼ä½äºå½“å‰çš„ layers æ—¶æ‰èƒ½å¯¼å…¥å®ƒä»¬ã€‚*

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé¡µé¢æ˜¯ä¸€ä¸ª sliceï¼Œæ‰€ä»¥è¿™ä¸ªé¡µé¢å†…éƒ¨çš„æ¨¡å—ï¼ˆæ–‡ä»¶ï¼‰åªèƒ½å¼•ç”¨ä¸‹å±‚ layers çš„ä»£ç ï¼Œè€Œä¸èƒ½å¼•ç”¨åŒä¸€ layer Pages çš„ä»£ç ã€‚

### ä»”ç»†æŸ¥çœ‹ feed

<figure>
  ![Anonymous userâ€™s perspective](../../../../../../static/img/tutorial/realworld-feed-anonymous.jpg)
  <figcaption>
    _Anonymous userâ€™s perspective_
  </figcaption>
</figure>

<figure>
  ![Authenticated userâ€™s perspective](../../../../../../static/img/tutorial/realworld-feed-authenticated.jpg)
  <figcaption>
    _Authenticated userâ€™s perspective_
  </figcaption>
</figure>

feed é¡µé¢ä¸Šæœ‰ä¸‰ä¸ªåŠ¨æ€åŒºåŸŸï¼š

1. å¸¦æœ‰ç™»å½•çŠ¶æ€æŒ‡ç¤ºçš„ç™»å½•é“¾æ¥
2. è§¦å‘ feed ä¸­è¿‡æ»¤çš„æ ‡ç­¾åˆ—è¡¨
3. ä¸€ä¸ª/ä¸¤ä¸ªæ–‡ç«  feedsï¼Œæ¯ç¯‡æ–‡ç« éƒ½æœ‰ä¸€ä¸ªç‚¹èµæŒ‰é’®

ç™»å½•é“¾æ¥æ˜¯æ‰€æœ‰é¡µé¢é€šç”¨çš„å¤´éƒ¨çš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†å•ç‹¬é‡æ–°è®¿é—®å®ƒã€‚

#### æ ‡ç­¾åˆ—è¡¨

è¦æ„å»ºæ ‡ç­¾åˆ—è¡¨ï¼Œæˆ‘ä»¬éœ€è¦è·å–å¯ç”¨çš„æ ‡ç­¾ï¼Œå°†æ¯ä¸ªæ ‡ç­¾æ¸²æŸ“ä¸ºèŠ¯ç‰‡ï¼Œå¹¶å°†é€‰ä¸­çš„æ ‡ç­¾å­˜å‚¨åœ¨å®¢æˆ·ç«¯å­˜å‚¨ä¸­ã€‚è¿™äº›æ“ä½œåˆ†åˆ«å±äºâ€œAPI äº¤äº’â€ã€â€œç”¨æˆ·ç•Œé¢â€å’Œâ€œå­˜å‚¨â€ç±»åˆ«ã€‚åœ¨ Feature-Sliced Design ä¸­ï¼Œä»£ç ä½¿ç”¨ *segments* æŒ‰ç›®çš„åˆ†ç¦»ã€‚Segments æ˜¯ slices ä¸­çš„æ–‡ä»¶å¤¹ï¼Œå®ƒä»¬å¯ä»¥æœ‰æè¿°ç›®çš„çš„ä»»æ„åç§°ï¼Œä½†æŸäº›ç›®çš„éå¸¸å¸¸è§ï¼Œä»¥è‡³äºæŸäº› segment åç§°æœ‰çº¦å®šï¼š

- ğŸ“‚ `api/` ç”¨äºåç«¯äº¤äº’
- ğŸ“‚ `ui/` ç”¨äºå¤„ç†æ¸²æŸ“å’Œå¤–è§‚çš„ä»£ç 
- ğŸ“‚ `model/` ç”¨äºå­˜å‚¨å’Œä¸šåŠ¡é€»è¾‘
- ğŸ“‚ `config/` ç”¨äº feature flagsã€ç¯å¢ƒå˜é‡å’Œå…¶ä»–å½¢å¼çš„é…ç½®

æˆ‘ä»¬å°†è·å–æ ‡ç­¾çš„ä»£ç æ”¾å…¥ `api`ï¼Œæ ‡ç­¾ç»„ä»¶æ”¾å…¥ `ui`ï¼Œå­˜å‚¨äº¤äº’æ”¾å…¥ `model`ã€‚

#### æ–‡ç« 

ä½¿ç”¨ç›¸åŒçš„åˆ†ç»„åŸåˆ™ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ–‡ç«  feed åˆ†è§£ä¸ºç›¸åŒçš„ä¸‰ä¸ª segmentsï¼š

- ğŸ“‚ `api/`: è·å–å¸¦æœ‰ç‚¹èµæ•°çš„åˆ†é¡µæ–‡ç« ï¼›ç‚¹èµæ–‡ç« 
- ğŸ“‚ `ui/`:
    - å¯ä»¥åœ¨é€‰ä¸­æ ‡ç­¾æ—¶æ¸²æŸ“é¢å¤–é€‰é¡¹å¡çš„é€‰é¡¹å¡åˆ—è¡¨
    - å•ä¸ªæ–‡ç« 
    - åŠŸèƒ½åˆ†é¡µ
- ğŸ“‚ `model/`: å½“å‰åŠ è½½çš„æ–‡ç« å’Œå½“å‰é¡µé¢çš„å®¢æˆ·ç«¯å­˜å‚¨ï¼ˆå¦‚æœéœ€è¦ï¼‰

### é‡ç”¨é€šç”¨ä»£ç 

å¤§å¤šæ•°é¡µé¢åœ¨æ„å›¾ä¸Šéå¸¸ä¸åŒï¼Œä½†æŸäº›ä¸œè¥¿åœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­ä¿æŒä¸å˜ â€” ä¾‹å¦‚ï¼Œç¬¦åˆè®¾è®¡è¯­è¨€çš„ UI å¥—ä»¶ï¼Œæˆ–åç«¯ä¸Šä½¿ç”¨ç›¸åŒè®¤è¯æ–¹æ³•çš„ REST API æ¥å®Œæˆæ‰€æœ‰äº‹æƒ…çš„çº¦å®šã€‚ç”±äº slices æ—¨åœ¨è¢«éš”ç¦»ï¼Œä»£ç é‡ç”¨ç”±æ›´ä½çš„ layer **Shared** ä¿ƒè¿›ã€‚

Shared ä¸å…¶ä»– layers ä¸åŒï¼Œå®ƒåŒ…å« segments è€Œä¸æ˜¯ slicesã€‚è¿™æ ·ï¼ŒShared layer å¯ä»¥è¢«è®¤ä¸ºæ˜¯ layer å’Œ slice ä¹‹é—´çš„æ··åˆä½“ã€‚

é€šå¸¸ï¼ŒShared ä¸­çš„ä»£ç ä¸æ˜¯æå‰è®¡åˆ’çš„ï¼Œè€Œæ˜¯åœ¨å¼€å‘è¿‡ç¨‹ä¸­æå–çš„ï¼Œå› ä¸ºåªæœ‰åœ¨å¼€å‘è¿‡ç¨‹ä¸­æ‰èƒ½æ˜ç¡®å“ªäº›ä»£ç éƒ¨åˆ†å®é™…ä¸Šæ˜¯å…±äº«çš„ã€‚ç„¶è€Œï¼Œè®°ä½å“ªç§ä»£ç è‡ªç„¶å±äº Shared ä»ç„¶æ˜¯æœ‰å¸®åŠ©çš„ï¼š

- ğŸ“‚Â `ui/` â€” the UI kit, pure appearance, no business logic. For example, buttons, modal dialogs, form inputs.
- ğŸ“‚Â `api/` â€” convenience wrappers around request making primitives (like `fetch()` on the Web) and, optionally, functions for triggering particular requests according to the backend specification.
- ğŸ“‚Â `config/` â€” parsing environment variables
- ğŸ“‚Â `i18n/` â€” configuration of language support
- ğŸ“‚Â `router/` â€” routing primitives and route constants

è¿™äº›åªæ˜¯ Shared ä¸­ segment åç§°çš„å‡ ä¸ªç¤ºä¾‹ï¼Œä½†æ‚¨å¯ä»¥çœç•¥å…¶ä¸­ä»»ä½•ä¸€ä¸ªæˆ–åˆ›å»ºè‡ªå·±çš„ã€‚åˆ›å»ºæ–° segments æ—¶è¦è®°ä½çš„å”¯ä¸€é‡è¦äº‹æƒ…æ˜¯ï¼Œsegment åç§°åº”è¯¥æè¿°**ç›®çš„ï¼ˆä¸ºä»€ä¹ˆï¼‰ï¼Œè€Œä¸æ˜¯æœ¬è´¨ï¼ˆæ˜¯ä»€ä¹ˆï¼‰**ã€‚åƒ "components"ã€"hooks"ã€"modals" è¿™æ ·çš„åç§°*ä¸åº”è¯¥*ä½¿ç”¨ï¼Œå› ä¸ºå®ƒä»¬æè¿°äº†è¿™äº›æ–‡ä»¶æ˜¯ä»€ä¹ˆï¼Œä½†ä¸èƒ½å¸®åŠ©åœ¨å†…éƒ¨å¯¼èˆªä»£ç ã€‚è¿™è¦æ±‚å›¢é˜Ÿä¸­çš„äººåœ¨è¿™æ ·çš„æ–‡ä»¶å¤¹ä¸­æŒ–æ˜æ¯ä¸ªæ–‡ä»¶ï¼Œå¹¶ä¸”ä¹Ÿä¿æŒä¸ç›¸å…³çš„ä»£ç æ¥è¿‘ï¼Œè¿™å¯¼è‡´äº†é‡æ„å½±å“çš„ä»£ç åŒºåŸŸå¹¿æ³›ï¼Œä»è€Œä½¿ä»£ç å®¡æŸ¥å’Œæµ‹è¯•æ›´åŠ å›°éš¾ã€‚

### å®šä¹‰ä¸¥æ ¼çš„ public API

åœ¨ Feature-Sliced Design çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œæœ¯è¯­ *public API* æŒ‡çš„æ˜¯ slice æˆ– segment å£°æ˜é¡¹ç›®ä¸­çš„å…¶ä»–æ¨¡å—å¯ä»¥ä»å®ƒå¯¼å…¥ä»€ä¹ˆã€‚ä¾‹å¦‚ï¼Œåœ¨ JavaScript ä¸­ï¼Œè¿™å¯ä»¥æ˜¯ä¸€ä¸ª `index.js` æ–‡ä»¶ï¼Œä» slice ä¸­çš„å…¶ä»–æ–‡ä»¶é‡æ–°å¯¼å‡ºå¯¹è±¡ã€‚è¿™ä½¿å¾—åœ¨ slice å†…éƒ¨é‡æ„ä»£ç çš„è‡ªç”±åº¦æˆä¸ºå¯èƒ½ï¼Œåªè¦ä¸å¤–éƒ¨ä¸–ç•Œçš„å¥‘çº¦ï¼ˆå³ public APIï¼‰ä¿æŒä¸å˜ã€‚

å¯¹äºæ²¡æœ‰ slices çš„ Shared layerï¼Œé€šå¸¸ä¸ºæ¯ä¸ª segment å®šä¹‰å•ç‹¬çš„ public API æ¯”å®šä¹‰ Shared ä¸­æ‰€æœ‰å†…å®¹çš„ä¸€ä¸ªå•ä¸€ç´¢å¼•æ›´æ–¹ä¾¿ã€‚è¿™ä½¿å¾—ä» Shared çš„å¯¼å…¥æŒ‰æ„å›¾è‡ªç„¶åœ°ç»„ç»‡ã€‚å¯¹äºå…·æœ‰ slices çš„å…¶ä»– layersï¼Œæƒ…å†µç›¸å â€” é€šå¸¸æ¯ä¸ª slice å®šä¹‰ä¸€ä¸ªç´¢å¼•å¹¶è®© slice å†³å®šå¤–éƒ¨ä¸–ç•ŒæœªçŸ¥çš„è‡ªå·±çš„ segments é›†åˆæ›´å®ç”¨ï¼Œå› ä¸ºå…¶ä»– layers é€šå¸¸æœ‰æ›´å°‘çš„å¯¼å‡ºã€‚

æˆ‘ä»¬çš„ slices/segments å°†ä»¥ä»¥ä¸‹æ–¹å¼ç›¸äº’å‡ºç°ï¼š

<FileTree>
- pages/
  - feed/
    - index
  - sign-in/
    - index
  - article-read/
    - index
  - ...
- shared/
  - ui/
    - index
  - api/
    - index
  - ...
</FileTree>

åƒ `pages/feed` æˆ– `shared/ui` è¿™æ ·çš„æ–‡ä»¶å¤¹å†…éƒ¨çš„ä»»ä½•å†…å®¹åªæœ‰è¿™äº›æ–‡ä»¶å¤¹çŸ¥é“ï¼Œå…¶ä»–æ–‡ä»¶ä¸åº”è¯¥ä¾èµ–è¿™äº›æ–‡ä»¶å¤¹çš„å†…éƒ¨ç»“æ„ã€‚

### UI ä¸­çš„å¤§å‹é‡ç”¨å—

æ—©äº›æ—¶å€™æˆ‘ä»¬è®°å½•äº†è¦é‡æ–°è®¿é—®å‡ºç°åœ¨æ¯ä¸ªé¡µé¢ä¸Šçš„å¤´éƒ¨ã€‚åœ¨æ¯ä¸ªé¡µé¢ä¸Šä»å¤´å¼€å§‹é‡å»ºå®ƒæ˜¯ä¸åˆ‡å®é™…çš„ï¼Œæ‰€ä»¥æƒ³è¦é‡ç”¨å®ƒæ˜¯å¾ˆè‡ªç„¶çš„ã€‚æˆ‘ä»¬å·²ç»æœ‰ Shared æ¥ä¿ƒè¿›ä»£ç é‡ç”¨ï¼Œç„¶è€Œï¼Œåœ¨ Shared ä¸­æ”¾ç½®å¤§å‹ UI å—æœ‰ä¸€ä¸ªè­¦å‘Š â€” Shared layer ä¸åº”è¯¥äº†è§£ä¸Šé¢çš„ä»»ä½• layersã€‚

åœ¨ Shared å’Œ Pages ä¹‹é—´æœ‰ä¸‰ä¸ªå…¶ä»– layersï¼šEntitiesã€Features å’Œ Widgetsã€‚æŸäº›é¡¹ç›®å¯èƒ½åœ¨è¿™äº› layers ä¸­æœ‰ä»–ä»¬åœ¨å¤§å‹å¯é‡ç”¨å—ä¸­éœ€è¦çš„ä¸œè¥¿ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ä¸èƒ½å°†è¯¥å¯é‡ç”¨å—æ”¾åœ¨ Shared ä¸­ï¼Œå¦åˆ™å®ƒå°†ä»ä¸Šå±‚ layers å¯¼å…¥ï¼Œè¿™æ˜¯è¢«ç¦æ­¢çš„ã€‚è¿™å°±æ˜¯ Widgets layer çš„ç”¨æ­¦ä¹‹åœ°ã€‚å®ƒä½äº Sharedã€Entities å’Œ Features ä¹‹ä¸Šï¼Œæ‰€ä»¥å®ƒå¯ä»¥ä½¿ç”¨å®ƒä»¬æ‰€æœ‰ã€‚

åœ¨æˆ‘ä»¬çš„æƒ…å†µä¸‹ï¼Œå¤´éƒ¨éå¸¸ç®€å• â€” å®ƒæ˜¯ä¸€ä¸ªé™æ€ logo å’Œé¡¶çº§å¯¼èˆªã€‚å¯¼èˆªéœ€è¦å‘ API å‘å‡ºè¯·æ±‚ä»¥ç¡®å®šç”¨æˆ·å½“å‰æ˜¯å¦å·²ç™»å½•ï¼Œä½†è¿™å¯ä»¥é€šè¿‡ä» `api` segment çš„ç®€å•å¯¼å…¥æ¥å¤„ç†ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†æŠŠæˆ‘ä»¬çš„å¤´éƒ¨ä¿ç•™åœ¨ Shared ä¸­ã€‚

### ä»”ç»†æŸ¥çœ‹å¸¦æœ‰è¡¨å•çš„é¡µé¢

è®©æˆ‘ä»¬ä¹Ÿæ£€æŸ¥ä¸€ä¸ªç”¨äºç¼–è¾‘è€Œä¸æ˜¯é˜…è¯»çš„é¡µé¢ã€‚ä¾‹å¦‚ï¼Œæ–‡ç« ç¼–å†™å™¨ï¼š

![Conduit post editor](../../../../../../static/img/tutorial/realworld-editor-authenticated.jpg)

å®ƒçœ‹èµ·æ¥å¾®ä¸è¶³é“ï¼Œä½†åŒ…å«äº†æˆ‘ä»¬å°šæœªæ¢ç´¢çš„åº”ç”¨ç¨‹åºå¼€å‘çš„å‡ ä¸ªæ–¹é¢ â€” è¡¨å•éªŒè¯ã€é”™è¯¯çŠ¶æ€å’Œæ•°æ®æŒä¹…åŒ–ã€‚

å¦‚æœæˆ‘ä»¬è¦æ„å»ºè¿™ä¸ªé¡µé¢ï¼Œæˆ‘ä»¬ä¼šä» Shared ä¸­è·å–ä¸€äº›è¾“å…¥å’ŒæŒ‰é’®ï¼Œå¹¶åœ¨æ­¤é¡µé¢çš„ `ui` segment ä¸­ç»„åˆä¸€ä¸ªè¡¨å•ã€‚ç„¶åï¼Œåœ¨ `api` segment ä¸­ï¼Œæˆ‘ä»¬å°†å®šä¹‰ä¸€ä¸ªå˜æ›´è¯·æ±‚ä»¥åœ¨åç«¯åˆ›å»ºæ–‡ç« ã€‚

ä¸ºäº†åœ¨å‘é€ä¹‹å‰éªŒè¯è¯·æ±‚ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªéªŒè¯æ¨¡å¼ï¼Œä¸€ä¸ªå¥½åœ°æ–¹æ˜¯ `model` segmentï¼Œå› ä¸ºå®ƒæ˜¯æ•°æ®æ¨¡å‹ã€‚åœ¨é‚£é‡Œæˆ‘ä»¬å°†äº§ç”Ÿé”™è¯¯æ¶ˆæ¯å¹¶ä½¿ç”¨ `ui` segment ä¸­çš„å¦ä¸€ä¸ªç»„ä»¶æ˜¾ç¤ºå®ƒä»¬ã€‚

ä¸ºäº†æ”¹å–„ç”¨æˆ·ä½“éªŒï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æŒä¹…åŒ–è¾“å…¥ä»¥é˜²æ­¢æ„å¤–æ•°æ®ä¸¢å¤±ã€‚è¿™ä¹Ÿæ˜¯ `model` segment çš„å·¥ä½œã€‚

### æ€»ç»“

æˆ‘ä»¬å·²ç»æ£€æŸ¥äº†å‡ ä¸ªé¡µé¢å¹¶ä¸ºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ¦‚è¿°äº†åˆæ­¥ç»“æ„ï¼š

1. Shared layer
    1. `ui` å°†åŒ…å«æˆ‘ä»¬å¯é‡ç”¨çš„ UI å¥—ä»¶
    2. `api` å°†åŒ…å«æˆ‘ä»¬ä¸åç«¯çš„åŸå§‹äº¤äº’
    3. å…¶ä½™å°†æ ¹æ®éœ€è¦å®‰æ’
2. Pages layer â€” æ¯ä¸ªé¡µé¢éƒ½æ˜¯ä¸€ä¸ªå•ç‹¬çš„ slice
    1. `ui` å°†åŒ…å«é¡µé¢æœ¬èº«åŠå…¶æ‰€æœ‰éƒ¨åˆ†
    2. `api` å°†åŒ…å«æ›´ä¸“é—¨çš„æ•°æ®è·å–ï¼Œä½¿ç”¨ `shared/api`
    3. `model` å¯èƒ½åŒ…å«æˆ‘ä»¬å°†æ˜¾ç¤ºçš„æ•°æ®çš„å®¢æˆ·ç«¯å­˜å‚¨

è®©æˆ‘ä»¬å¼€å§‹æ„å»ºå§ï¼

## ç¬¬äºŒéƒ¨åˆ†ã€‚åœ¨ä»£ç ä¸­

ç°åœ¨æˆ‘ä»¬æœ‰äº†è®¡åˆ’ï¼Œè®©æˆ‘ä»¬ä»˜è¯¸å®è·µã€‚æˆ‘ä»¬å°†ä½¿ç”¨ React å’Œ [Remix](https://remix.run)ã€‚

æœ‰ä¸€ä¸ªä¸ºæ­¤é¡¹ç›®å‡†å¤‡çš„æ¨¡æ¿ï¼Œä» GitHub å…‹éš†å®ƒä»¥è·å¾—å…ˆæœºï¼š[https://github.com/feature-sliced/tutorial-conduit/tree/clean](https://github.com/feature-sliced/tutorial-conduit/tree/clean)ã€‚

ä½¿ç”¨ `npm install` å®‰è£…ä¾èµ–é¡¹å¹¶ä½¿ç”¨ `npm run dev` å¯åŠ¨å¼€å‘æœåŠ¡å™¨ã€‚æ‰“å¼€ [http://localhost:3000](http://localhost:3000)ï¼Œæ‚¨åº”è¯¥çœ‹åˆ°ä¸€ä¸ªç©ºç™½åº”ç”¨ç¨‹åºã€‚

### å¸ƒå±€é¡µé¢

è®©æˆ‘ä»¬é¦–å…ˆä¸ºæ‰€æœ‰é¡µé¢åˆ›å»ºç©ºç™½ç»„ä»¶ã€‚åœ¨æ‚¨çš„é¡¹ç›®ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
npx fsd pages feed sign-in article-read article-edit profile settings --segments ui
```

è¿™å°†ä¸ºæ¯ä¸ªé¡µé¢åˆ›å»ºåƒ `pages/feed/ui/` è¿™æ ·çš„æ–‡ä»¶å¤¹å’Œä¸€ä¸ªç´¢å¼•æ–‡ä»¶ `pages/feed/index.ts`ã€‚

### è¿æ¥ feed é¡µé¢

è®©æˆ‘ä»¬å°†åº”ç”¨ç¨‹åºçš„æ ¹è·¯ç”±è¿æ¥åˆ° feed é¡µé¢ã€‚åœ¨ `pages/feed/ui` ä¸­åˆ›å»ºä¸€ä¸ªç»„ä»¶ `FeedPage.tsx` å¹¶å°†ä»¥ä¸‹å†…å®¹æ”¾å…¥å…¶ä¸­ï¼š


```tsx title="pages/feed/ui/FeedPage.tsx"
export function FeedPage() {
  return (
    <div className="home-page">
      <div className="banner">
        <div className="container">
          <h1 className="logo-font">conduit</h1>
          <p>A place to share your knowledge.</p>
        </div>
      </div>
    </div>
  );
}
```

ç„¶ååœ¨ feed é¡µé¢çš„ public APIï¼Œ`pages/feed/index.ts` æ–‡ä»¶ä¸­é‡æ–°å¯¼å‡ºæ­¤ç»„ä»¶ï¼š



```ts title="pages/feed/index.ts"
export { FeedPage } from "./ui/FeedPage";
```

ç°åœ¨å°†å®ƒè¿æ¥åˆ°æ ¹è·¯ç”±ã€‚åœ¨ Remix ä¸­ï¼Œè·¯ç”±æ˜¯åŸºäºæ–‡ä»¶çš„ï¼Œè·¯ç”±æ–‡ä»¶ä½äº `app/routes` æ–‡ä»¶å¤¹ä¸­ï¼Œè¿™ä¸ Feature-Sliced Design å¾ˆå¥½åœ°å¥‘åˆã€‚

åœ¨ `app/routes/_index.tsx` ä¸­ä½¿ç”¨ `FeedPage` ç»„ä»¶ï¼š

```tsx title="app/routes/_index.tsx"
import type { MetaFunction } from "@remix-run/node";
import { FeedPage } from "pages/feed";

export const meta: MetaFunction = () => {
  return [{ title: "Conduit" }];
};

export default FeedPage;
```

ç„¶åï¼Œå¦‚æœæ‚¨è¿è¡Œå¼€å‘æœåŠ¡å™¨å¹¶æ‰“å¼€åº”ç”¨ç¨‹åºï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ° Conduit æ¨ªå¹…ï¼

![The banner of Conduit](../../../../../../static/img/tutorial/conduit-banner.jpg)

### API å®¢æˆ·ç«¯

ä¸ºäº†ä¸ RealWorld åç«¯é€šä¿¡ï¼Œè®©æˆ‘ä»¬åœ¨ Shared ä¸­åˆ›å»ºä¸€ä¸ªæ–¹ä¾¿çš„ API å®¢æˆ·ç«¯ã€‚åˆ›å»ºä¸¤ä¸ª segmentsï¼Œ`api` ç”¨äºå®¢æˆ·ç«¯ï¼Œ`config` ç”¨äºåƒåç«¯åŸºç¡€ URL è¿™æ ·çš„å˜é‡ï¼š

```bash
npx fsd shared --segments api config
```

ç„¶ååˆ›å»º `shared/config/backend.ts`ï¼š

```tsx title="shared/config/backend.ts"
export { mockBackendUrl as backendBaseUrl } from "mocks/handlers";
```

```tsx title="shared/config/index.ts"
export { backendBaseUrl } from "./backend";
```

ç”±äº RealWorld é¡¹ç›®æ–¹ä¾¿åœ°æä¾›äº† [OpenAPI è§„èŒƒ](https://github.com/gothinkster/realworld/blob/main/api/openapi.yml)ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¸ºæˆ‘ä»¬çš„å®¢æˆ·ç«¯è‡ªåŠ¨ç”Ÿæˆçš„ç±»å‹ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ [the `openapi-fetch` package](https://openapi-ts.pages.dev/openapi-fetch/)ï¼Œå®ƒé™„å¸¦ä¸€ä¸ªé¢å¤–çš„ç±»å‹ç”Ÿæˆå™¨ã€‚

è¿è¡Œä»¥ä¸‹å‘½ä»¤ç”Ÿæˆæœ€æ–°çš„ API ç±»å‹ï¼š

```bash
npm run generate-api-types
```

è¿™å°†åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ `shared/api/v1.d.ts`ã€‚æˆ‘ä»¬å°†ä½¿ç”¨æ­¤æ–‡ä»¶åœ¨ `shared/api/client.ts` ä¸­åˆ›å»ºä¸€ä¸ªç±»å‹åŒ–çš„ API å®¢æˆ·ç«¯ï¼š

```tsx title="shared/api/client.ts"
import createClient from "openapi-fetch";

import { backendBaseUrl } from "shared/config";
import type { paths } from "./v1";

export const { GET, POST, PUT, DELETE } = createClient<paths>({ baseUrl: backendBaseUrl });
```

```tsx title="shared/api/index.ts"
export { GET, POST, PUT, DELETE } from "./client";
```

### feed ä¸­çš„çœŸå®æ•°æ®

æˆ‘ä»¬ç°åœ¨å¯ä»¥ç»§ç»­å‘ feed æ·»åŠ ä»åç«¯è·å–çš„æ–‡ç« ã€‚è®©æˆ‘ä»¬é¦–å…ˆå®ç°ä¸€ä¸ªæ–‡ç« é¢„è§ˆç»„ä»¶ã€‚

ä½¿ç”¨ä»¥ä¸‹å†…å®¹åˆ›å»º `pages/feed/ui/ArticlePreview.tsx`ï¼š

```tsx title="pages/feed/ui/ArticlePreview.tsx"
export function ArticlePreview({ article }) { /* TODO */ }
```

ç”±äºæˆ‘ä»¬ç”¨ TypeScript ç¼–å†™ï¼Œæœ‰ä¸€ä¸ªç±»å‹åŒ–çš„ article å¯¹è±¡ä¼šå¾ˆå¥½ã€‚å¦‚æœæˆ‘ä»¬æ¢ç´¢ç”Ÿæˆçš„ `v1.d.ts`ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° article å¯¹è±¡å¯ä»¥é€šè¿‡ `components["schemas"]["Article"]` è·å¾—ã€‚æ‰€ä»¥è®©æˆ‘ä»¬åœ¨ Shared ä¸­åˆ›å»ºä¸€ä¸ªåŒ…å«æˆ‘ä»¬æ•°æ®æ¨¡å‹çš„æ–‡ä»¶å¹¶å¯¼å‡ºæ¨¡å‹ï¼š

```tsx title="shared/api/models.ts"
import type { components } from "./v1";

export type Article = components["schemas"]["Article"];
```

```tsx title="shared/api/index.ts"
export { GET, POST, PUT, DELETE } from "./client";

export type { Article } from "./models";
```

ç°åœ¨æˆ‘ä»¬å¯ä»¥å›åˆ°æ–‡ç« é¢„è§ˆç»„ä»¶å¹¶ç”¨æ•°æ®å¡«å……æ ‡è®°ã€‚ä½¿ç”¨ä»¥ä¸‹å†…å®¹æ›´æ–°ç»„ä»¶ï¼š

```tsx title="pages/feed/ui/ArticlePreview.tsx"
import { Link } from "@remix-run/react";
import type { Article } from "shared/api";

interface ArticlePreviewProps {
  article: Article;
}

export function ArticlePreview({ article }: ArticlePreviewProps) {
  return (
    <div className="article-preview">
      <div className="article-meta">
        <Link to={`/profile/${article.author.username}`} prefetch="intent">
          <img src={article.author.image} alt="" />
        </Link>
        <div className="info">
          <Link
            to={`/profile/${article.author.username}`}
            className="author"
            prefetch="intent"
          >
            {article.author.username}
          </Link>
          <span className="date" suppressHydrationWarning>
            {new Date(article.createdAt).toLocaleDateString(undefined, {
              dateStyle: "long",
            })}
          </span>
        </div>
        <button className="btn btn-outline-primary btn-sm pull-xs-right">
          <i className="ion-heart"></i> {article.favoritesCount}
        </button>
      </div>
      <Link
        to={`/article/${article.slug}`}
        className="preview-link"
        prefetch="intent"
      >
        <h1>{article.title}</h1>
        <p>{article.description}</p>
        <span>Read more...</span>
        <ul className="tag-list">
          {article.tagList.map((tag) => (
            <li key={tag} className="tag-default tag-pill tag-outline">
              {tag}
            </li>
          ))}
        </ul>
      </Link>
    </div>
  );
}
```

ç‚¹èµæŒ‰é’®ç›®å‰ä¸åšä»»ä½•äº‹æƒ…ï¼Œæˆ‘ä»¬å°†åœ¨åˆ°è¾¾æ–‡ç« é˜…è¯»å™¨é¡µé¢å¹¶å®ç°ç‚¹èµåŠŸèƒ½æ—¶ä¿®å¤å®ƒã€‚

ç°åœ¨æˆ‘ä»¬å¯ä»¥è·å–æ–‡ç« å¹¶æ¸²æŸ“å‡ºä¸€å †è¿™äº›å¡ç‰‡ã€‚åœ¨ Remix ä¸­è·å–æ•°æ®æ˜¯é€šè¿‡ *loaders* å®Œæˆçš„ â€” æœåŠ¡å™¨ç«¯å‡½æ•°ï¼Œè·å–é¡µé¢æ‰€éœ€çš„ç¡®åˆ‡å†…å®¹ã€‚Loaders ä»£è¡¨é¡µé¢ä¸ API äº¤äº’ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†å®ƒä»¬æ”¾åœ¨é¡µé¢çš„ `api` segment ä¸­ï¼š

```tsx title="pages/feed/api/loader.ts"
import { json } from "@remix-run/node";

import { GET } from "shared/api";

export const loader = async () => {
  const { data: articles, error, response } = await GET("/articles");

  if (error !== undefined) {
    throw json(error, { status: response.status });
  }

  return json({ articles });
};
```

è¦å°†å®ƒè¿æ¥åˆ°é¡µé¢ï¼Œæˆ‘ä»¬éœ€è¦ä»è·¯ç”±æ–‡ä»¶ä¸­ä»¥åç§° `loader` å¯¼å‡ºå®ƒï¼š

```tsx title="pages/feed/index.ts"
export { FeedPage } from "./ui/FeedPage";
export { loader } from "./api/loader";
```

```tsx title="app/routes/_index.tsx"
import type { MetaFunction } from "@remix-run/node";
import { FeedPage } from "pages/feed";

export { loader } from "pages/feed";

export const meta: MetaFunction = () => {
  return [{ title: "Conduit" }];
};

export default FeedPage;
```

æœ€åä¸€æ­¥æ˜¯åœ¨ feed ä¸­æ¸²æŸ“è¿™äº›å¡ç‰‡ã€‚ä½¿ç”¨ä»¥ä¸‹ä»£ç æ›´æ–°æ‚¨çš„ `FeedPage`ï¼š

```tsx title="pages/feed/ui/FeedPage.tsx"
import { useLoaderData } from "@remix-run/react";

import type { loader } from "../api/loader";
import { ArticlePreview } from "./ArticlePreview";

export function FeedPage() {
  const { articles } = useLoaderData<typeof loader>();

  return (
    <div className="home-page">
      <div className="banner">
        <div className="container">
          <h1 className="logo-font">conduit</h1>
          <p>A place to share your knowledge.</p>
        </div>
      </div>

      <div className="container page">
        <div className="row">
          <div className="col-md-9">
            {articles.articles.map((article) => (
              <ArticlePreview key={article.slug} article={article} />
            ))}
          </div>
        </div>
      </div>
    </div>
  );
}
```

### æŒ‰æ ‡ç­¾è¿‡æ»¤

å…³äºæ ‡ç­¾ï¼Œæˆ‘ä»¬çš„å·¥ä½œæ˜¯ä»åç«¯è·å–å®ƒä»¬å¹¶å­˜å‚¨å½“å‰é€‰ä¸­çš„æ ‡ç­¾ã€‚æˆ‘ä»¬å·²ç»çŸ¥é“å¦‚ä½•è¿›è¡Œè·å– â€” è¿™æ˜¯æ¥è‡ª loader çš„å¦ä¸€ä¸ªè¯·æ±‚ã€‚æˆ‘ä»¬å°†ä½¿ç”¨æ¥è‡ªå·²å®‰è£…çš„ `remix-utils` åŒ…çš„ä¾¿åˆ©å‡½æ•° `promiseHash`ã€‚

ä½¿ç”¨ä»¥ä¸‹ä»£ç æ›´æ–° loader æ–‡ä»¶ `pages/feed/api/loader.ts`ï¼š

```tsx title="pages/feed/api/loader.ts"
import { json } from "@remix-run/node";
import type { FetchResponse } from "openapi-fetch";
import { promiseHash } from "remix-utils/promise";

import { GET } from "shared/api";

async function throwAnyErrors<T, O, Media extends `${string}/${string}`>(
  responsePromise: Promise<FetchResponse<T, O, Media>>,
) {
  const { data, error, response } = await responsePromise;

  if (error !== undefined) {
    throw json(error, { status: response.status });
  }

  return data as NonNullable<typeof data>;
}

export const loader = async () => {
  return json(
    await promiseHash({
      articles: throwAnyErrors(GET("/articles")),
      tags: throwAnyErrors(GET("/tags")),
    }),
  );
};
```

æ‚¨å¯èƒ½ä¼šæ³¨æ„åˆ°æˆ‘ä»¬å°†é”™è¯¯å¤„ç†æå–åˆ°ä¸€ä¸ªé€šç”¨å‡½æ•° `throwAnyErrors` ä¸­ã€‚å®ƒçœ‹èµ·æ¥éå¸¸æœ‰ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯èƒ½å¸Œæœ›ç¨åé‡ç”¨å®ƒï¼Œä½†ç°åœ¨è®©æˆ‘ä»¬å…ˆç•™æ„ä¸€ä¸‹ã€‚

ç°åœ¨ï¼Œåˆ°æ ‡ç­¾åˆ—è¡¨ã€‚å®ƒéœ€è¦æ˜¯äº¤äº’å¼çš„ â€” ç‚¹å‡»æ ‡ç­¾åº”è¯¥ä½¿è¯¥æ ‡ç­¾è¢«é€‰ä¸­ã€‚æŒ‰ç…§ Remix çº¦å®šï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ URL æœç´¢å‚æ•°ä½œä¸ºæˆ‘ä»¬é€‰ä¸­æ ‡ç­¾çš„å­˜å‚¨ã€‚è®©æµè§ˆå™¨å¤„ç†å­˜å‚¨ï¼Œè€Œæˆ‘ä»¬ä¸“æ³¨äºæ›´é‡è¦çš„äº‹æƒ…ã€‚

ä½¿ç”¨ä»¥ä¸‹ä»£ç æ›´æ–° `pages/feed/ui/FeedPage.tsx`ï¼š

```tsx title="pages/feed/ui/FeedPage.tsx"
import { Form, useLoaderData } from "@remix-run/react";
import { ExistingSearchParams } from "remix-utils/existing-search-params";

import type { loader } from "../api/loader";
import { ArticlePreview } from "./ArticlePreview";

export function FeedPage() {
  const { articles, tags } = useLoaderData<typeof loader>();

  return (
    <div className="home-page">
      <div className="banner">
        <div className="container">
          <h1 className="logo-font">conduit</h1>
          <p>A place to share your knowledge.</p>
        </div>
      </div>

      <div className="container page">
        <div className="row">
          <div className="col-md-9">
            {articles.articles.map((article) => (
              <ArticlePreview key={article.slug} article={article} />
            ))}
          </div>

          <div className="col-md-3">
            <div className="sidebar">
              <p>Popular Tags</p>

              <Form>
                <ExistingSearchParams exclude={["tag"]} />
                <div className="tag-list">
                  {tags.tags.map((tag) => (
                    <button
                      key={tag}
                      name="tag"
                      value={tag}
                      className="tag-pill tag-default"
                    >
                      {tag}
                    </button>
                  ))}
                </div>
              </Form>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
} 
```

ç„¶åæˆ‘ä»¬éœ€è¦åœ¨æˆ‘ä»¬çš„ loader ä¸­ä½¿ç”¨ `tag` æœç´¢å‚æ•°ã€‚å°† `pages/feed/api/loader.ts` ä¸­çš„ `loader` å‡½æ•°æ›´æ”¹ä¸ºä»¥ä¸‹å†…å®¹ï¼š

```tsx title="pages/feed/api/loader.ts"
import { json, type LoaderFunctionArgs } from "@remix-run/node";
import type { FetchResponse } from "openapi-fetch";
import { promiseHash } from "remix-utils/promise";

import { GET } from "shared/api";

async function throwAnyErrors<T, O, Media extends `${string}/${string}`>(
  responsePromise: Promise<FetchResponse<T, O, Media>>,
) {
  const { data, error, response } = await responsePromise;

  if (error !== undefined) {
    throw json(error, { status: response.status });
  }

  return data as NonNullable<typeof data>;
}

export const loader = async ({ request }: LoaderFunctionArgs) => {
  const url = new URL(request.url);
  const selectedTag = url.searchParams.get("tag") ?? undefined;

  return json(
    await promiseHash({
      articles: throwAnyErrors(
        GET("/articles", { params: { query: { tag: selectedTag } } }),
      ),
      tags: throwAnyErrors(GET("/tags")),
    }),
  );
};
```

å°±æ˜¯è¿™æ ·ï¼Œä¸éœ€è¦ `model` segmentã€‚Remix éå¸¸æ•´æ´ã€‚

### åˆ†é¡µ

ä»¥ç±»ä¼¼çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°åˆ†é¡µã€‚éšæ„è‡ªå·±å°è¯•ä¸€ä¸‹æˆ–ç›´æ¥å¤åˆ¶ä¸‹é¢çš„ä»£ç ã€‚åæ­£æ²¡æœ‰äººä¼šåˆ¤æ–­æ‚¨ã€‚

```tsx title="pages/feed/api/loader.ts"
import { json, type LoaderFunctionArgs } from "@remix-run/node";
import type { FetchResponse } from "openapi-fetch";
import { promiseHash } from "remix-utils/promise";

import { GET } from "shared/api";

async function throwAnyErrors<T, O, Media extends `${string}/${string}`>(
  responsePromise: Promise<FetchResponse<T, O, Media>>,
) {
  const { data, error, response } = await responsePromise;

  if (error !== undefined) {
    throw json(error, { status: response.status });
  }

  return data as NonNullable<typeof data>;
}

/** Amount of articles on one page. */
export const LIMIT = 20;

export const loader = async ({ request }: LoaderFunctionArgs) => {
  const url = new URL(request.url);
  const selectedTag = url.searchParams.get("tag") ?? undefined;
  const page = parseInt(url.searchParams.get("page") ?? "", 10);

  return json(
    await promiseHash({
      articles: throwAnyErrors(
        GET("/articles", {
          params: {
            query: {
              tag: selectedTag,
              limit: LIMIT,
              offset: !Number.isNaN(page) ? page * LIMIT : undefined,
            },
          },
        }),
      ),
      tags: throwAnyErrors(GET("/tags")),
    }),
  );
};
```

```tsx title="pages/feed/ui/FeedPage.tsx"
import { Form, useLoaderData, useSearchParams } from "@remix-run/react";
import { ExistingSearchParams } from "remix-utils/existing-search-params";

import { LIMIT, type loader } from "../api/loader";
import { ArticlePreview } from "./ArticlePreview";

export function FeedPage() {
  const [searchParams] = useSearchParams();
  const { articles, tags } = useLoaderData<typeof loader>();
  const pageAmount = Math.ceil(articles.articlesCount / LIMIT);
  const currentPage = parseInt(searchParams.get("page") ?? "1", 10);

  return (
    <div className="home-page">
      <div className="banner">
        <div className="container">
          <h1 className="logo-font">conduit</h1>
          <p>A place to share your knowledge.</p>
        </div>
      </div>

      <div className="container page">
        <div className="row">
          <div className="col-md-9">
            {articles.articles.map((article) => (
              <ArticlePreview key={article.slug} article={article} />
            ))}

            <Form>
              <ExistingSearchParams exclude={["page"]} />
              <ul className="pagination">
                {Array(pageAmount)
                  .fill(null)
                  .map((_, index) =>
                    index + 1 === currentPage ? (
                      <li key={index} className="page-item active">
                        <span className="page-link">{index + 1}</span>
                      </li>
                    ) : (
                      <li key={index} className="page-item">
                        <button
                          className="page-link"
                          name="page"
                          value={index + 1}
                        >
                          {index + 1}
                        </button>
                      </li>
                    ),
                  )}
              </ul>
            </Form>
          </div>

          <div className="col-md-3">
            <div className="sidebar">
              <p>Popular Tags</p>

              <Form>
                <ExistingSearchParams exclude={["tag", "page"]} />
                <div className="tag-list">
                  {tags.tags.map((tag) => (
                    <button
                      key={tag}
                      name="tag"
                      value={tag}
                      className="tag-pill tag-default"
                    >
                      {tag}
                    </button>
                  ))}
                </div>
              </Form>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
```

è¿™æ ·ä¹Ÿå®Œæˆäº†ã€‚è¿˜æœ‰é€‰é¡¹å¡åˆ—è¡¨å¯ä»¥ç±»ä¼¼åœ°å®ç°ï¼Œä½†è®©æˆ‘ä»¬ç­‰åˆ°å®ç°èº«ä»½éªŒè¯æ—¶å†å¤„ç†ã€‚è¯´åˆ°è¿™ä¸ªï¼

### èº«ä»½éªŒè¯

èº«ä»½éªŒè¯æ¶‰åŠä¸¤ä¸ªé¡µé¢ â€” ä¸€ä¸ªç”¨äºç™»å½•ï¼Œå¦ä¸€ä¸ªç”¨äºæ³¨å†Œã€‚å®ƒä»¬å¤§éƒ¨åˆ†ç›¸åŒï¼Œæ‰€ä»¥å°†å®ƒä»¬ä¿æŒåœ¨åŒä¸€ä¸ª slice `sign-in` ä¸­æ˜¯æœ‰æ„ä¹‰çš„ï¼Œè¿™æ ·å®ƒä»¬å¯ä»¥åœ¨éœ€è¦æ—¶é‡ç”¨ä»£ç ã€‚

åœ¨ `pages/sign-in` çš„ `ui` segment ä¸­åˆ›å»º `RegisterPage.tsx`ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```tsx title="pages/sign-in/ui/RegisterPage.tsx"
import { Form, Link, useActionData } from "@remix-run/react";

import type { register } from "../api/register";

export function RegisterPage() {
  const registerData = useActionData<typeof register>();

  return (
    <div className="auth-page">
      <div className="container page">
        <div className="row">
          <div className="col-md-6 offset-md-3 col-xs-12">
            <h1 className="text-xs-center">Sign up</h1>
            <p className="text-xs-center">
              <Link to="/login">Have an account?</Link>
            </p>

            {registerData?.error && (
              <ul className="error-messages">
                {registerData.error.errors.body.map((error) => (
                  <li key={error}>{error}</li>
                ))}
              </ul>
            )}

            <Form method="post">
              <fieldset className="form-group">
                <input
                  className="form-control form-control-lg"
                  type="text"
                  name="username"
                  placeholder="Username"
                />
              </fieldset>
              <fieldset className="form-group">
                <input
                  className="form-control form-control-lg"
                  type="text"
                  name="email"
                  placeholder="Email"
                />
              </fieldset>
              <fieldset className="form-group">
                <input
                  className="form-control form-control-lg"
                  type="password"
                  name="password"
                  placeholder="Password"
                />
              </fieldset>
              <button className="btn btn-lg btn-primary pull-xs-right">
                Sign up
              </button>
            </Form>
          </div>
        </div>
      </div>
    </div>
  );
}
```

æˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ªæŸåçš„å¯¼å…¥è¦ä¿®å¤ã€‚å®ƒæ¶‰åŠä¸€ä¸ªæ–°çš„ segmentï¼Œæ‰€ä»¥åˆ›å»ºå®ƒï¼š

```bash
npx fsd pages sign-in -s api
```

ç„¶è€Œï¼Œåœ¨æˆ‘ä»¬å¯ä»¥å®ç°æ³¨å†Œçš„åç«¯éƒ¨åˆ†ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ä¸€äº›ä¾› Remix å¤„ç†ä¼šè¯çš„åŸºç¡€è®¾æ–½ä»£ç ã€‚è¿™æ”¾åœ¨ Shared ä¸­ï¼Œä»¥é˜²å…¶ä»–é¡µé¢éœ€è¦å®ƒã€‚

å°†ä»¥ä¸‹ä»£ç æ”¾å…¥ `shared/api/auth.server.ts`ã€‚è¿™é«˜åº¦ç‰¹å®šäº Remixï¼Œæ‰€ä»¥ä¸è¦å¤ªæ‹…å¿ƒï¼Œåªéœ€å¤åˆ¶ç²˜è´´ï¼š

```tsx title="shared/api/auth.server.ts"
import { createCookieSessionStorage, redirect } from "@remix-run/node";
import invariant from "tiny-invariant";

import type { User } from "./models";

invariant(
  process.env.SESSION_SECRET,
  "SESSION_SECRET must be set for authentication to work",
);

const sessionStorage = createCookieSessionStorage<{
  user: User;
}>({
  cookie: {
    name: "__session",
    httpOnly: true,
    path: "/",
    sameSite: "lax",
    secrets: [process.env.SESSION_SECRET],
    secure: process.env.NODE_ENV === "production",
  },
});

export async function createUserSession({
  request,
  user,
  redirectTo,
}: {
  request: Request;
  user: User;
  redirectTo: string;
}) {
  const cookie = request.headers.get("Cookie");
  const session = await sessionStorage.getSession(cookie);

  session.set("user", user);

  return redirect(redirectTo, {
    headers: {
      "Set-Cookie": await sessionStorage.commitSession(session, {
        maxAge: 60 * 60 * 24 * 7, // 7 days
      }),
    },
  });
}

export async function getUserFromSession(request: Request) {
  const cookie = request.headers.get("Cookie");
  const session = await sessionStorage.getSession(cookie);

  return session.get("user") ?? null;
}

export async function requireUser(request: Request) {
  const user = await getUserFromSession(request);

  if (user === null) {
    throw redirect("/login");
  }

  return user;
}
```

åŒæ—¶ä»æ—è¾¹çš„ `models.ts` æ–‡ä»¶ä¸­å¯¼å‡º `User` æ¨¡å‹ï¼š

```tsx title="shared/api/models.ts"
import type { components } from "./v1";

export type Article = components["schemas"]["Article"];
export type User = components["schemas"]["User"];
```

åœ¨æ­¤ä»£ç èƒ½å¤Ÿå·¥ä½œä¹‹å‰ï¼Œéœ€è¦è®¾ç½® `SESSION_SECRET` ç¯å¢ƒå˜é‡ã€‚åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªåä¸º `.env` çš„æ–‡ä»¶ï¼Œå†™å…¥ `SESSION_SECRET=`ï¼Œç„¶ååœ¨é”®ç›˜ä¸Šéšæ„æ•²å‡»ä¸€äº›é”®æ¥åˆ›å»ºä¸€ä¸ªé•¿çš„éšæœºå­—ç¬¦ä¸²ã€‚æ‚¨åº”è¯¥å¾—åˆ°ç±»ä¼¼è¿™æ ·çš„ä¸œè¥¿ï¼š

```bash title=".env"
SESSION_SECRET=dontyoudarecopypastethis
```

æœ€åï¼Œå‘ public API æ·»åŠ ä¸€äº›å¯¼å‡ºä»¥ä½¿ç”¨æ­¤ä»£ç ï¼š

```tsx title="shared/api/index.ts"
export { GET, POST, PUT, DELETE } from "./client";

export type { Article } from "./models";

export { createUserSession, getUserFromSession, requireUser } from "./auth.server";
```

ç°åœ¨æˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸ RealWorld åç«¯é€šä¿¡ä»¥å®é™…è¿›è¡Œæ³¨å†Œçš„ä»£ç ã€‚æˆ‘ä»¬å°†å…¶ä¿å­˜åœ¨ `pages/sign-in/api` ä¸­ã€‚åˆ›å»ºä¸€ä¸ªåä¸º `register.ts` çš„æ–‡ä»¶ï¼Œå¹¶å°†ä»¥ä¸‹ä»£ç æ”¾å…¥å…¶ä¸­ï¼š

```tsx title="pages/sign-in/api/register.ts"
import { json, type ActionFunctionArgs } from "@remix-run/node";

import { POST, createUserSession } from "shared/api";

export const register = async ({ request }: ActionFunctionArgs) => {
  const formData = await request.formData();
  const username = formData.get("username")?.toString() ?? "";
  const email = formData.get("email")?.toString() ?? "";
  const password = formData.get("password")?.toString() ?? "";

  const { data, error } = await POST("/users", {
    body: { user: { email, password, username } },
  });

  if (error) {
    return json({ error }, { status: 400 });
  } else {
    return createUserSession({
      request: request,
      user: data.user,
      redirectTo: "/",
    });
  }
};
```

```tsx title="pages/sign-in/index.ts"
export { RegisterPage } from './ui/RegisterPage';
export { register } from './api/register';
```

å‡ ä¹å®Œæˆäº†ï¼åªéœ€è¦å°†é¡µé¢å’Œæ“ä½œè¿æ¥åˆ° `/register` è·¯ç”±ã€‚åœ¨ `app/routes` ä¸­åˆ›å»º `register.tsx`ï¼š

```tsx title="app/routes/register.tsx"
import { RegisterPage, register } from "pages/sign-in";

export { register as action };

export default RegisterPage;
```

ç°åœ¨å¦‚æœæ‚¨è½¬åˆ° [http://localhost:3000/register](http://localhost:3000/register)ï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿåˆ›å»ºç”¨æˆ·ï¼åº”ç”¨ç¨‹åºçš„å…¶ä½™éƒ¨åˆ†è¿˜ä¸ä¼šå¯¹æ­¤åšå‡ºååº”ï¼Œæˆ‘ä»¬å°†ç«‹å³è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

ä»¥éå¸¸ç±»ä¼¼çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ç™»å½•é¡µé¢ã€‚å°è¯•ä¸€ä¸‹æˆ–ç›´æ¥è·å–ä»£ç å¹¶ç»§ç»­ï¼š

```tsx title="pages/sign-in/api/sign-in.ts"
import { json, type ActionFunctionArgs } from "@remix-run/node";

import { POST, createUserSession } from "shared/api";

export const signIn = async ({ request }: ActionFunctionArgs) => {
  const formData = await request.formData();
  const email = formData.get("email")?.toString() ?? "";
  const password = formData.get("password")?.toString() ?? "";

  const { data, error } = await POST("/users/login", {
    body: { user: { email, password } },
  });

  if (error) {
    return json({ error }, { status: 400 });
  } else {
    return createUserSession({
      request: request,
      user: data.user,
      redirectTo: "/",
    });
  }
};
```

```tsx title="pages/sign-in/ui/SignInPage.tsx"
import { Form, Link, useActionData } from "@remix-run/react";

import type { signIn } from "../api/sign-in";

export function SignInPage() {
  const signInData = useActionData<typeof signIn>();

  return (
    <div className="auth-page">
      <div className="container page">
        <div className="row">
          <div className="col-md-6 offset-md-3 col-xs-12">
            <h1 className="text-xs-center">Sign in</h1>
            <p className="text-xs-center">
              <Link to="/register">Need an account?</Link>
            </p>

            {signInData?.error && (
              <ul className="error-messages">
                {signInData.error.errors.body.map((error) => (
                  <li key={error}>{error}</li>
                ))}
              </ul>
            )}

            <Form method="post">
              <fieldset className="form-group">
                <input
                  className="form-control form-control-lg"
                  name="email"
                  type="text"
                  placeholder="Email"
                />
              </fieldset>
              <fieldset className="form-group">
                <input
                  className="form-control form-control-lg"
                  name="password"
                  type="password"
                  placeholder="Password"
                />
              </fieldset>
              <button className="btn btn-lg btn-primary pull-xs-right">
                Sign in
              </button>
            </Form>
          </div>
        </div>
      </div>
    </div>
  );
}
```

```tsx title="pages/sign-in/index.ts"
export { RegisterPage } from './ui/RegisterPage';
export { register } from './api/register';
export { SignInPage } from './ui/SignInPage';
export { signIn } from './api/sign-in';
```

```tsx title="app/routes/login.tsx"
import { SignInPage, signIn } from "pages/sign-in";

export { signIn as action };

export default SignInPage;
```

ç°åœ¨è®©æˆ‘ä»¬ç»™ç”¨æˆ·ä¸€ç§å®é™…è¾¾åˆ°è¿™äº›é¡µé¢çš„æ–¹æ³•ã€‚

### å¤´éƒ¨

æ­£å¦‚æˆ‘ä»¬åœ¨ç¬¬ä¸€éƒ¨åˆ†ä¸­è®¨è®ºçš„ï¼Œåº”ç”¨ç¨‹åºå¤´éƒ¨é€šå¸¸æ”¾åœ¨ Widgets æˆ– Shared ä¸­ã€‚æˆ‘ä»¬å°†å…¶æ”¾åœ¨ Shared ä¸­ï¼Œå› ä¸ºå®ƒéå¸¸ç®€å•ï¼Œæ‰€æœ‰ä¸šåŠ¡é€»è¾‘éƒ½å¯ä»¥ä¿æŒåœ¨å®ƒä¹‹å¤–ã€‚è®©æˆ‘ä»¬ä¸ºå®ƒåˆ›å»ºä¸€ä¸ªåœ°æ–¹ï¼š

```bash
npx fsd shared ui
```

ç°åœ¨åˆ›å»º `shared/ui/Header.tsx`ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```tsx title="shared/ui/Header.tsx"
import { useContext } from "react";
import { Link, useLocation } from "@remix-run/react";

import { CurrentUser } from "../api/currentUser";

export function Header() {
  const currentUser = useContext(CurrentUser);
  const { pathname } = useLocation();

  return (
    <nav className="navbar navbar-light">
      <div className="container">
        <Link className="navbar-brand" to="/" prefetch="intent">
          conduit
        </Link>
        <ul className="nav navbar-nav pull-xs-right">
          <li className="nav-item">
            <Link
              prefetch="intent"
              className={`nav-link ${pathname == "/" ? "active" : ""}`}
              to="/"
            >
              Home
            </Link>
          </li>
          {currentUser == null ? (
            <>
              <li className="nav-item">
                <Link
                  prefetch="intent"
                  className={`nav-link ${pathname == "/login" ? "active" : ""}`}
                  to="/login"
                >
                  Sign in
                </Link>
              </li>
              <li className="nav-item">
                <Link
                  prefetch="intent"
                  className={`nav-link ${pathname == "/register" ? "active" : ""}`}
                  to="/register"
                >
                  Sign up
                </Link>
              </li>
            </>
          ) : (
            <>
              <li className="nav-item">
                <Link
                  prefetch="intent"
                  className={`nav-link ${pathname == "/editor" ? "active" : ""}`}
                  to="/editor"
                >
                  <i className="ion-compose"></i>&nbsp;New Article{" "}
                </Link>
              </li>

              <li className="nav-item">
                <Link
                  prefetch="intent"
                  className={`nav-link ${pathname == "/settings" ? "active" : ""}`}
                  to="/settings"
                >
                  {" "}
                  <i className="ion-gear-a"></i>&nbsp;Settings{" "}
                </Link>
              </li>
              <li className="nav-item">
                <Link
                  prefetch="intent"
                  className={`nav-link ${pathname.includes("/profile") ? "active" : ""}`}
                  to={`/profile/${currentUser.username}`}
                >
                  {currentUser.image && (
                    <img
                      width={25}
                      height={25}
                      src={currentUser.image}
                      className="user-pic"
                      alt=""
                    />
                  )}
                  {currentUser.username}
                </Link>
              </li>
            </>
          )}
        </ul>
      </div>
    </nav>
  );
}
```

ä» `shared/ui` å¯¼å‡ºæ­¤ç»„ä»¶ï¼š

```tsx title="shared/ui/index.ts"
export { Header } from "./Header";
```

åœ¨å¤´éƒ¨ä¸­ï¼Œæˆ‘ä»¬ä¾èµ–ä¿å­˜åœ¨ `shared/api` ä¸­çš„ä¸Šä¸‹æ–‡ã€‚ä¹Ÿåˆ›å»ºå®ƒï¼š

```tsx title="shared/api/currentUser.ts"
import { createContext } from "react";

import type { User } from "./models";

export const CurrentUser = createContext<User | null>(null);
```

```tsx title="shared/api/index.ts"
export { GET, POST, PUT, DELETE } from "./client";

export type { Article } from "./models";

export { createUserSession, getUserFromSession, requireUser } from "./auth.server";
export { CurrentUser } from "./currentUser";
```

ç°åœ¨è®©æˆ‘ä»¬å°†å¤´éƒ¨æ·»åŠ åˆ°é¡µé¢ã€‚æˆ‘ä»¬å¸Œæœ›å®ƒå‡ºç°åœ¨æ¯ä¸€ä¸ªé¡µé¢ä¸Šï¼Œæ‰€ä»¥ç®€å•åœ°å°†å…¶æ·»åŠ åˆ°æ ¹è·¯ç”±å¹¶ç”¨ `CurrentUser` ä¸Šä¸‹æ–‡æä¾›è€…åŒ…è£… outletï¼ˆé¡µé¢å°†è¢«æ¸²æŸ“çš„åœ°æ–¹ï¼‰æ˜¯æœ‰æ„ä¹‰çš„ã€‚è¿™æ ·æˆ‘ä»¬çš„æ•´ä¸ªåº”ç”¨ç¨‹åºä»¥åŠå¤´éƒ¨éƒ½å¯ä»¥è®¿é—®å½“å‰ç”¨æˆ·å¯¹è±¡ã€‚æˆ‘ä»¬è¿˜å°†æ·»åŠ ä¸€ä¸ª loader æ¥å®é™…ä» cookies ä¸­è·å–å½“å‰ç”¨æˆ·å¯¹è±¡ã€‚å°†ä»¥ä¸‹å†…å®¹æ”¾å…¥ `app/root.tsx`ï¼š

```tsx title="app/root.tsx"
import { cssBundleHref } from "@remix-run/css-bundle";
import type { LinksFunction, LoaderFunctionArgs } from "@remix-run/node";
import {
  Links,
  LiveReload,
  Meta,
  Outlet,
  Scripts,
  ScrollRestoration,
  useLoaderData,
} from "@remix-run/react";

import { Header } from "shared/ui";
import { getUserFromSession, CurrentUser } from "shared/api";

export const links: LinksFunction = () => [
  ...(cssBundleHref ? [{ rel: "stylesheet", href: cssBundleHref }] : []),
];

export const loader = ({ request }: LoaderFunctionArgs) =>
  getUserFromSession(request);

export default function App() {
  const user = useLoaderData<typeof loader>();

  return (
    <html lang="en">
      <head>
        <meta charSet="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <Meta />
        <Links />
        <link
          href="//code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css"
          rel="stylesheet"
          type="text/css"
        />
        <link
          href="//fonts.googleapis.com/css?family=Titillium+Web:700|Source+Serif+Pro:400,700|Merriweather+Sans:400,700|Source+Sans+Pro:400,300,600,700,300italic,400italic,600italic,700italic"
          rel="stylesheet"
          type="text/css"
        />
        <link rel="stylesheet" href="//demo.productionready.io/main.css" />
        <style>{`
          button {
            border: 0;
          }
        `}</style>
      </head>
      <body>
        <CurrentUser.Provider value={user}>
          <Header />
          <Outlet />
        </CurrentUser.Provider>
        <ScrollRestoration />
        <Scripts />
        <LiveReload />
      </body>
    </html>
  );
}
```

åœ¨è¿™ä¸€ç‚¹ï¼Œæ‚¨åº”è¯¥åœ¨ä¸»é¡µä¸Šå¾—åˆ°ä»¥ä¸‹ç»“æœï¼š

<figure>
  ![The feed page of Conduit, including the header, the feed, and the tags. The tabs are still missing.](../../../../../../static/img/tutorial/realworld-feed-without-tabs.jpg)

  <figcaption>The feed page of Conduit, including the header, the feed, and the tags. The tabs are still missing.</figcaption>
</figure>

### é€‰é¡¹å¡

ç°åœ¨æˆ‘ä»¬å¯ä»¥æ£€æµ‹èº«ä»½éªŒè¯çŠ¶æ€ï¼Œè®©æˆ‘ä»¬ä¹Ÿå¿«é€Ÿå®ç°é€‰é¡¹å¡å’Œå¸–å­ç‚¹èµæ¥å®Œæˆ feed é¡µé¢ã€‚æˆ‘ä»¬éœ€è¦å¦ä¸€ä¸ªè¡¨å•ï¼Œä½†è¿™ä¸ªé¡µé¢æ–‡ä»¶æ­£åœ¨å˜å¾—æœ‰ç‚¹å¤§ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬å°†è¿™äº›è¡¨å•ç§»åŠ¨åˆ°ç›¸é‚»çš„æ–‡ä»¶ä¸­ã€‚æˆ‘ä»¬å°†åˆ›å»º `Tabs.tsx`ã€`PopularTags.tsx` å’Œ `Pagination.tsx`ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```tsx title="pages/feed/ui/Tabs.tsx"
import { useContext } from "react";
import { Form, useSearchParams } from "@remix-run/react";

import { CurrentUser } from "shared/api";

export function Tabs() {
  const [searchParams] = useSearchParams();
  const currentUser = useContext(CurrentUser);

  return (
    <Form>
      <div className="feed-toggle">
        <ul className="nav nav-pills outline-active">
          {currentUser !== null && (
            <li className="nav-item">
              <button
                name="source"
                value="my-feed"
                className={`nav-link ${searchParams.get("source") === "my-feed" ? "active" : ""}`}
              >
                Your Feed
              </button>
            </li>
          )}
          <li className="nav-item">
            <button
              className={`nav-link ${searchParams.has("tag") || searchParams.has("source") ? "" : "active"}`}
            >
              Global Feed
            </button>
          </li>
          {searchParams.has("tag") && (
            <li className="nav-item">
              <span className="nav-link active">
                <i className="ion-pound"></i> {searchParams.get("tag")}
              </span>
            </li>
          )}
        </ul>
      </div>
    </Form>
  );
}
```

```tsx title="pages/feed/ui/PopularTags.tsx"
import { Form, useLoaderData } from "@remix-run/react";
import { ExistingSearchParams } from "remix-utils/existing-search-params";

import type { loader } from "../api/loader";

export function PopularTags() {
  const { tags } = useLoaderData<typeof loader>();

  return (
    <div className="sidebar">
      <p>Popular Tags</p>

      <Form>
        <ExistingSearchParams exclude={["tag", "page", "source"]} />
        <div className="tag-list">
          {tags.tags.map((tag) => (
            <button
              key={tag}
              name="tag"
              value={tag}
              className="tag-pill tag-default"
            >
              {tag}
            </button>
          ))}
        </div>
      </Form>
    </div>
  );
}
```

```tsx title="pages/feed/ui/Pagination.tsx"
import { Form, useLoaderData, useSearchParams } from "@remix-run/react";
import { ExistingSearchParams } from "remix-utils/existing-search-params";

import { LIMIT, type loader } from "../api/loader";

export function Pagination() {
  const [searchParams] = useSearchParams();
  const { articles } = useLoaderData<typeof loader>();
  const pageAmount = Math.ceil(articles.articlesCount / LIMIT);
  const currentPage = parseInt(searchParams.get("page") ?? "1", 10);

  return (
    <Form>
      <ExistingSearchParams exclude={["page"]} />
      <ul className="pagination">
        {Array(pageAmount)
          .fill(null)
          .map((_, index) =>
            index + 1 === currentPage ? (
              <li key={index} className="page-item active">
                <span className="page-link">{index + 1}</span>
              </li>
            ) : (
              <li key={index} className="page-item">
                <button className="page-link" name="page" value={index + 1}>
                  {index + 1}
                </button>
              </li>
            ),
          )}
      </ul>
    </Form>
  );
}
```

ç°åœ¨æˆ‘ä»¬å¯ä»¥æ˜¾è‘—ç®€åŒ– feed é¡µé¢æœ¬èº«ï¼š

```tsx title="pages/feed/ui/FeedPage.tsx"
import { useLoaderData } from "@remix-run/react";

import type { loader } from "../api/loader";
import { ArticlePreview } from "./ArticlePreview";
import { Tabs } from "./Tabs";
import { PopularTags } from "./PopularTags";
import { Pagination } from "./Pagination";

export function FeedPage() {
  const { articles } = useLoaderData<typeof loader>();

  return (
    <div className="home-page">
      <div className="banner">
        <div className="container">
          <h1 className="logo-font">conduit</h1>
          <p>A place to share your knowledge.</p>
        </div>
      </div>

      <div className="container page">
        <div className="row">
          <div className="col-md-9">
            <Tabs />

            {articles.articles.map((article) => (
              <ArticlePreview key={article.slug} article={article} />
            ))}

            <Pagination />
          </div>

          <div className="col-md-3">
            <PopularTags />
          </div>
        </div>
      </div>
    </div>
  );
}
```

æˆ‘ä»¬è¿˜éœ€è¦åœ¨ loader å‡½æ•°ä¸­è€ƒè™‘æ–°é€‰é¡¹å¡ï¼š

```tsx title="pages/feed/api/loader.ts"
import { json, type LoaderFunctionArgs } from "@remix-run/node";
import type { FetchResponse } from "openapi-fetch";
import { promiseHash } from "remix-utils/promise";

import { GET, requireUser } from "shared/api";

async function throwAnyErrors<T, O, Media extends `${string}/${string}`>(
  responsePromise: Promise<FetchResponse<T, O, Media>>,
) {
  /* unchanged */
}

/** Amount of articles on one page. */
export const LIMIT = 20;

export const loader = async ({ request }: LoaderFunctionArgs) => {
  const url = new URL(request.url);
  const selectedTag = url.searchParams.get("tag") ?? undefined;
  const page = parseInt(url.searchParams.get("page") ?? "", 10);

  if (url.searchParams.get("source") === "my-feed") {
    const userSession = await requireUser(request);

    return json(
      await promiseHash({
        articles: throwAnyErrors(
          GET("/articles/feed", {
            params: {
              query: {
                limit: LIMIT,
                offset: !Number.isNaN(page) ? page * LIMIT : undefined,
              },
            },
            headers: { Authorization: `Token ${userSession.token}` },
          }),
        ),
        tags: throwAnyErrors(GET("/tags")),
      }),
    );
  }

  return json(
    await promiseHash({
      articles: throwAnyErrors(
        GET("/articles", {
          params: {
            query: {
              tag: selectedTag,
              limit: LIMIT,
              offset: !Number.isNaN(page) ? page * LIMIT : undefined,
            },
          },
        }),
      ),
      tags: throwAnyErrors(GET("/tags")),
    }),
  );
};
```

åœ¨æˆ‘ä»¬ç¦»å¼€ feed é¡µé¢ä¹‹å‰ï¼Œè®©æˆ‘ä»¬æ·»åŠ ä¸€äº›å¤„ç†å¸–å­ç‚¹èµçš„ä»£ç ã€‚å°†æ‚¨çš„ `ArticlePreview.tsx` æ›´æ”¹ä¸ºä»¥ä¸‹å†…å®¹ï¼š

```tsx title="pages/feed/ui/ArticlePreview.tsx"
import { Form, Link } from "@remix-run/react";
import type { Article } from "shared/api";

interface ArticlePreviewProps {
  article: Article;
}

export function ArticlePreview({ article }: ArticlePreviewProps) {
  return (
    <div className="article-preview">
      <div className="article-meta">
        <Link to={`/profile/${article.author.username}`} prefetch="intent">
          <img src={article.author.image} alt="" />
        </Link>
        <div className="info">
          <Link
            to={`/profile/${article.author.username}`}
            className="author"
            prefetch="intent"
          >
            {article.author.username}
          </Link>
          <span className="date" suppressHydrationWarning>
            {new Date(article.createdAt).toLocaleDateString(undefined, {
              dateStyle: "long",
            })}
          </span>
        </div>
        <Form
          method="post"
          action={`/article/${article.slug}`}
          preventScrollReset
        >
          <button
            name="_action"
            value={article.favorited ? "unfavorite" : "favorite"}
            className={`btn ${article.favorited ? "btn-primary" : "btn-outline-primary"} btn-sm pull-xs-right`}
          >
            <i className="ion-heart"></i> {article.favoritesCount}
          </button>
        </Form>
      </div>
      <Link
        to={`/article/${article.slug}`}
        className="preview-link"
        prefetch="intent"
      >
        <h1>{article.title}</h1>
        <p>{article.description}</p>
        <span>Read more...</span>
        <ul className="tag-list">
          {article.tagList.map((tag) => (
            <li key={tag} className="tag-default tag-pill tag-outline">
              {tag}
            </li>
          ))}
        </ul>
      </Link>
    </div>
  );
}
```

æ­¤ä»£ç å°†å‘ `/article/:slug` å‘é€å¸¦æœ‰ `_action=favorite` çš„ POST è¯·æ±‚ä»¥å°†æ–‡ç« æ ‡è®°ä¸ºæ”¶è—ã€‚å®ƒè¿˜ä¸ä¼šå·¥ä½œï¼Œä½†å½“æˆ‘ä»¬å¼€å§‹å¤„ç†æ–‡ç« é˜…è¯»å™¨æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿä¼šå®ç°è¿™ä¸ªåŠŸèƒ½ã€‚

è¿™æ ·æˆ‘ä»¬å°±æ­£å¼å®Œæˆäº† feedï¼å¤ªå¥½äº†ï¼

### æ–‡ç« é˜…è¯»å™¨

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ•°æ®ã€‚è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª loaderï¼š

```bash
npx fsd pages article-read -s api
```

```tsx title="pages/article-read/api/loader.ts"
import { json, type LoaderFunctionArgs } from "@remix-run/node";
import invariant from "tiny-invariant";
import type { FetchResponse } from "openapi-fetch";
import { promiseHash } from "remix-utils/promise";

import { GET, getUserFromSession } from "shared/api";

async function throwAnyErrors<T, O, Media extends `${string}/${string}`>(
  responsePromise: Promise<FetchResponse<T, O, Media>>,
) {
  const { data, error, response } = await responsePromise;

  if (error !== undefined) {
    throw json(error, { status: response.status });
  }

  return data as NonNullable<typeof data>;
}

export const loader = async ({ request, params }: LoaderFunctionArgs) => {
  invariant(params.slug, "Expected a slug parameter");
  const currentUser = await getUserFromSession(request);
  const authorization = currentUser
    ? { Authorization: `Token ${currentUser.token}` }
    : undefined;

  return json(
    await promiseHash({
      article: throwAnyErrors(
        GET("/articles/{slug}", {
          params: {
            path: { slug: params.slug },
          },
          headers: authorization,
        }),
      ),
      comments: throwAnyErrors(
        GET("/articles/{slug}/comments", {
          params: {
            path: { slug: params.slug },
          },
          headers: authorization,
        }),
      ),
    }),
  );
};
```

```tsx title="pages/article-read/index.ts"
export { loader } from "./api/loader";
```

ç°åœ¨æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ›å»ºä¸€ä¸ªåä¸º `article.$slug.tsx` çš„è·¯ç”±æ–‡ä»¶å°†å…¶è¿æ¥åˆ°è·¯ç”± `/article/:slug`ï¼š

```tsx title="app/routes/article.$slug.tsx"
export { loader } from "pages/article-read";
```

é¡µé¢æœ¬èº«ç”±ä¸‰ä¸ªä¸»è¦å—ç»„æˆ â€” å¸¦æœ‰æ“ä½œçš„æ–‡ç« å¤´éƒ¨ï¼ˆé‡å¤ä¸¤æ¬¡ï¼‰ã€æ–‡ç« ä¸»ä½“å’Œè¯„è®ºéƒ¨åˆ†ã€‚è¿™æ˜¯é¡µé¢çš„æ ‡è®°ï¼Œå®ƒå¹¶ä¸ç‰¹åˆ«æœ‰è¶£ï¼š

```tsx title="pages/article-read/ui/ArticleReadPage.tsx"
import { useLoaderData } from "@remix-run/react";

import type { loader } from "../api/loader";
import { ArticleMeta } from "./ArticleMeta";
import { Comments } from "./Comments";

export function ArticleReadPage() {
  const { article } = useLoaderData<typeof loader>();

  return (
    <div className="article-page">
      <div className="banner">
        <div className="container">
          <h1>{article.article.title}</h1>

          <ArticleMeta />
        </div>
      </div>

      <div className="container page">
        <div className="row article-content">
          <div className="col-md-12">
            <p>{article.article.body}</p>
            <ul className="tag-list">
              {article.article.tagList.map((tag) => (
                <li className="tag-default tag-pill tag-outline" key={tag}>
                  {tag}
                </li>
              ))}
            </ul>
          </div>
        </div>

        <hr />

        <div className="article-actions">
          <ArticleMeta />
        </div>

        <div className="row">
          <Comments />
        </div>
      </div>
    </div>
  );
}
```

æ›´æœ‰è¶£çš„æ˜¯ `ArticleMeta` å’Œ `Comments`ã€‚å®ƒä»¬åŒ…å«å†™æ“ä½œï¼Œå¦‚ç‚¹èµæ–‡ç« ã€ç•™ä¸‹è¯„è®ºç­‰ã€‚è¦è®©å®ƒä»¬å·¥ä½œï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦å®ç°åç«¯éƒ¨åˆ†ã€‚åœ¨é¡µé¢çš„ `api` segment ä¸­åˆ›å»º `action.ts`ï¼š

```tsx title="pages/article-read/api/action.ts"
import { redirect, type ActionFunctionArgs } from "@remix-run/node";
import { namedAction } from "remix-utils/named-action";
import { redirectBack } from "remix-utils/redirect-back";
import invariant from "tiny-invariant";

import { DELETE, POST, requireUser } from "shared/api";

export const action = async ({ request, params }: ActionFunctionArgs) => {
  const currentUser = await requireUser(request);

  const authorization = { Authorization: `Token ${currentUser.token}` };

  const formData = await request.formData();

  return namedAction(formData, {
    async delete() {
      invariant(params.slug, "Expected a slug parameter");
      await DELETE("/articles/{slug}", {
        params: { path: { slug: params.slug } },
        headers: authorization,
      });
      return redirect("/");
    },
    async favorite() {
      invariant(params.slug, "Expected a slug parameter");
      await POST("/articles/{slug}/favorite", {
        params: { path: { slug: params.slug } },
        headers: authorization,
      });
      return redirectBack(request, { fallback: "/" });
    },
    async unfavorite() {
      invariant(params.slug, "Expected a slug parameter");
      await DELETE("/articles/{slug}/favorite", {
        params: { path: { slug: params.slug } },
        headers: authorization,
      });
      return redirectBack(request, { fallback: "/" });
    },
    async createComment() {
      invariant(params.slug, "Expected a slug parameter");
      const comment = formData.get("comment");
      invariant(typeof comment === "string", "Expected a comment parameter");
      await POST("/articles/{slug}/comments", {
        params: { path: { slug: params.slug } },
        headers: { ...authorization, "Content-Type": "application/json" },
        body: { comment: { body: comment } },
      });
      return redirectBack(request, { fallback: "/" });
    },
    async deleteComment() {
      invariant(params.slug, "Expected a slug parameter");
      const commentId = formData.get("id");
      invariant(typeof commentId === "string", "Expected an id parameter");
      const commentIdNumeric = parseInt(commentId, 10);
      invariant(
        !Number.isNaN(commentIdNumeric),
        "Expected a numeric id parameter",
      );
      await DELETE("/articles/{slug}/comments/{id}", {
        params: { path: { slug: params.slug, id: commentIdNumeric } },
        headers: authorization,
      });
      return redirectBack(request, { fallback: "/" });
    },
    async followAuthor() {
      const authorUsername = formData.get("username");
      invariant(
        typeof authorUsername === "string",
        "Expected a username parameter",
      );
      await POST("/profiles/{username}/follow", {
        params: { path: { username: authorUsername } },
        headers: authorization,
      });
      return redirectBack(request, { fallback: "/" });
    },
    async unfollowAuthor() {
      const authorUsername = formData.get("username");
      invariant(
        typeof authorUsername === "string",
        "Expected a username parameter",
      );
      await DELETE("/profiles/{username}/follow", {
        params: { path: { username: authorUsername } },
        headers: authorization,
      });
      return redirectBack(request, { fallback: "/" });
    },
  });
};
```

ä» slice ä¸­å¯¼å‡ºå®ƒï¼Œç„¶åä»è·¯ç”±ä¸­å¯¼å‡ºã€‚è¶ç€è¿™ä¸ªæœºä¼šï¼Œè®©æˆ‘ä»¬ä¹Ÿè¿æ¥é¡µé¢æœ¬èº«ï¼š

```tsx title="pages/article-read/index.ts"
export { ArticleReadPage } from "./ui/ArticleReadPage";
export { loader } from "./api/loader";
export { action } from "./api/action";
```

```tsx title="app/routes/article.$slug.tsx"
import { ArticleReadPage } from "pages/article-read";

export { loader, action } from "pages/article-read";

export default ArticleReadPage;
```

ç°åœ¨ï¼Œå°½ç®¡æˆ‘ä»¬è¿˜æ²¡æœ‰åœ¨é˜…è¯»å™¨é¡µé¢ä¸Šå®ç°ç‚¹èµæŒ‰é’®ï¼Œä½† feed ä¸­çš„ç‚¹èµæŒ‰é’®å°†å¼€å§‹å·¥ä½œï¼è¿™æ˜¯å› ä¸ºå®ƒä¸€ç›´åœ¨å‘è¿™ä¸ªè·¯ç”±å‘é€"ç‚¹èµ"è¯·æ±‚ã€‚è¯•è¯•çœ‹å§ã€‚

`ArticleMeta` å’Œ `Comments` åˆæ˜¯ä¸€å †è¡¨å•ã€‚æˆ‘ä»¬ä¹‹å‰å·²ç»åšè¿‡è¿™ä¸ªï¼Œè®©æˆ‘ä»¬è·å–å®ƒä»¬çš„ä»£ç å¹¶ç»§ç»­ï¼š

```tsx title="pages/article-read/ui/ArticleMeta.tsx"
import { Form, Link, useLoaderData } from "@remix-run/react";
import { useContext } from "react";

import { CurrentUser } from "shared/api";
import type { loader } from "../api/loader";

export function ArticleMeta() {
  const currentUser = useContext(CurrentUser);
  const { article } = useLoaderData<typeof loader>();

  return (
    <Form method="post">
      <div className="article-meta">
        <Link
          prefetch="intent"
          to={`/profile/${article.article.author.username}`}
        >
          <img src={article.article.author.image} alt="" />
        </Link>

        <div className="info">
          <Link
            prefetch="intent"
            to={`/profile/${article.article.author.username}`}
            className="author"
          >
            {article.article.author.username}
          </Link>
          <span className="date">{article.article.createdAt}</span>
        </div>

        {article.article.author.username == currentUser?.username ? (
          <>
            <Link
              prefetch="intent"
              to={`/editor/${article.article.slug}`}
              className="btn btn-sm btn-outline-secondary"
            >
              <i className="ion-edit"></i> Edit Article
            </Link>
            &nbsp;&nbsp;
            <button
              name="_action"
              value="delete"
              className="btn btn-sm btn-outline-danger"
            >
              <i className="ion-trash-a"></i> Delete Article
            </button>
          </>
        ) : (
          <>
            <input
              name="username"
              value={article.article.author.username}
              type="hidden"
            />
            <button
              name="_action"
              value={
                article.article.author.following
                  ? "unfollowAuthor"
                  : "followAuthor"
              }
              className={`btn btn-sm ${article.article.author.following ? "btn-secondary" : "btn-outline-secondary"}`}
            >
              <i className="ion-plus-round"></i>
              &nbsp;{" "}
              {article.article.author.following
                ? "Unfollow"
                : "Follow"}{" "}
              {article.article.author.username}
            </button>
            &nbsp;&nbsp;
            <button
              name="_action"
              value={article.article.favorited ? "unfavorite" : "favorite"}
              className={`btn btn-sm ${article.article.favorited ? "btn-primary" : "btn-outline-primary"}`}
            >
              <i className="ion-heart"></i>
              &nbsp; {article.article.favorited
                ? "Unfavorite"
                : "Favorite"}{" "}
              Post{" "}
              <span className="counter">
                ({article.article.favoritesCount})
              </span>
            </button>
          </>
        )}
      </div>
    </Form>
  );
}
```

```tsx title="pages/article-read/ui/Comments.tsx"
import { useContext } from "react";
import { Form, Link, useLoaderData } from "@remix-run/react";

import { CurrentUser } from "shared/api";
import type { loader } from "../api/loader";

export function Comments() {
  const { comments } = useLoaderData<typeof loader>();
  const currentUser = useContext(CurrentUser);

  return (
    <div className="col-xs-12 col-md-8 offset-md-2">
      {currentUser !== null ? (
        <Form
          preventScrollReset={true}
          method="post"
          className="card comment-form"
        >
          <div className="card-block">
            <textarea
              required
              className="form-control"
              name="comment"
              placeholder="Write a comment..."
              rows={3}
            ></textarea>
          </div>
          <div className="card-footer">
            <img
              src={currentUser.image}
              className="comment-author-img"
              alt=""
            />
            <button
              className="btn btn-sm btn-primary"
              name="_action"
              value="createComment"
            >
              Post Comment
            </button>
          </div>
        </Form>
      ) : (
        <div className="row">
          <div className="col-xs-12 col-md-8 offset-md-2">
            <p>
              <Link to="/login">Sign in</Link>
              &nbsp; or &nbsp;
              <Link to="/register">Sign up</Link>
              &nbsp; to add comments on this article.
            </p>
          </div>
        </div>
      )}

      {comments.comments.map((comment) => (
        <div className="card" key={comment.id}>
          <div className="card-block">
            <p className="card-text">{comment.body}</p>
          </div>

          <div className="card-footer">
            <Link
              to={`/profile/${comment.author.username}`}
              className="comment-author"
            >
              <img
                src={comment.author.image}
                className="comment-author-img"
                alt=""
              />
            </Link>
            &nbsp;
            <Link
              to={`/profile/${comment.author.username}`}
              className="comment-author"
            >
              {comment.author.username}
            </Link>
            <span className="date-posted">{comment.createdAt}</span>
            {comment.author.username === currentUser?.username && (
              <span className="mod-options">
                <Form method="post" preventScrollReset={true}>
                  <input type="hidden" name="id" value={comment.id} />
                  <button
                    name="_action"
                    value="deleteComment"
                    style={{
                      border: "none",
                      outline: "none",
                      backgroundColor: "transparent",
                    }}
                  >
                    <i className="ion-trash-a"></i>
                  </button>
                </Form>
              </span>
            )}
          </div>
        </div>
      ))}
    </div>
  );
}
```

è¿™æ ·æˆ‘ä»¬çš„æ–‡ç« é˜…è¯»å™¨ä¹Ÿå®Œæˆäº†ï¼å…³æ³¨ä½œè€…ã€ç‚¹èµå¸–å­å’Œç•™ä¸‹è¯„è®ºçš„æŒ‰é’®ç°åœ¨åº”è¯¥èƒ½æŒ‰é¢„æœŸå·¥ä½œã€‚

<figure>
  ![Article reader with functioning buttons to like and follow](../../../../../../static/img/tutorial/realworld-article-reader.jpg)

  <figcaption>Article reader with functioning buttons to like and follow</figcaption>
</figure>

### æ–‡ç« ç¼–è¾‘å™¨

è¿™æ˜¯æˆ‘ä»¬å°†åœ¨æœ¬æ•™ç¨‹ä¸­æ¶µç›–çš„æœ€åä¸€ä¸ªé¡µé¢ï¼Œè¿™é‡Œæœ€æœ‰è¶£çš„éƒ¨åˆ†æ˜¯æˆ‘ä»¬å°†å¦‚ä½•éªŒè¯è¡¨å•æ•°æ®ã€‚

é¡µé¢æœ¬èº«ï¼Œ`article-edit/ui/ArticleEditPage.tsx`ï¼Œå°†éå¸¸ç®€å•ï¼Œé¢å¤–çš„å¤æ‚æ€§è¢«å­˜å‚¨åˆ°å…¶ä»–ä¸¤ä¸ªç»„ä»¶ä¸­ï¼š

```tsx title="pages/article-edit/ui/ArticleEditPage.tsx"
import { Form, useLoaderData } from "@remix-run/react";

import type { loader } from "../api/loader";
import { TagsInput } from "./TagsInput";
import { FormErrors } from "./FormErrors";

export function ArticleEditPage() {
  const article = useLoaderData<typeof loader>();

  return (
    <div className="editor-page">
      <div className="container page">
        <div className="row">
          <div className="col-md-10 offset-md-1 col-xs-12">
            <FormErrors />

            <Form method="post">
              <fieldset>
                <fieldset className="form-group">
                  <input
                    type="text"
                    className="form-control form-control-lg"
                    name="title"
                    placeholder="Article Title"
                    defaultValue={article.article?.title}
                  />
                </fieldset>
                <fieldset className="form-group">
                  <input
                    type="text"
                    className="form-control"
                    name="description"
                    placeholder="What's this article about?"
                    defaultValue={article.article?.description}
                  />
                </fieldset>
                <fieldset className="form-group">
                  <textarea
                    className="form-control"
                    name="body"
                    rows={8}
                    placeholder="Write your article (in markdown)"
                    defaultValue={article.article?.body}
                  ></textarea>
                </fieldset>
                <fieldset className="form-group">
                  <TagsInput
                    name="tags"
                    defaultValue={article.article?.tagList ?? []}
                  />
                </fieldset>

                <button className="btn btn-lg pull-xs-right btn-primary">
                  Publish Article
                </button>
              </fieldset>
            </Form>
          </div>
        </div>
      </div>
    </div>
  );
}
```

æ­¤é¡µé¢è·å–å½“å‰æ–‡ç« ï¼ˆé™¤éæˆ‘ä»¬ä»å¤´å¼€å§‹ç¼–å†™ï¼‰å¹¶å¡«å†™ç›¸åº”çš„è¡¨å•å­—æ®µã€‚æˆ‘ä»¬ä¹‹å‰è§è¿‡è¿™ä¸ªã€‚æœ‰è¶£çš„éƒ¨åˆ†æ˜¯ `FormErrors`ï¼Œå› ä¸ºå®ƒå°†æ¥æ”¶éªŒè¯ç»“æœå¹¶å‘ç”¨æˆ·æ˜¾ç¤ºã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ï¼š

```tsx title="pages/article-edit/ui/FormErrors.tsx"
import { useActionData } from "@remix-run/react";
import type { action } from "../api/action";

export function FormErrors() {
  const actionData = useActionData<typeof action>();

  return actionData?.errors != null ? (
    <ul className="error-messages">
      {actionData.errors.map((error) => (
        <li key={error}>{error}</li>
      ))}
    </ul>
  ) : null;
}
```

è¿™é‡Œæˆ‘ä»¬å‡è®¾æˆ‘ä»¬çš„ action å°†è¿”å› `errors` å­—æ®µï¼Œä¸€ä¸ªäººç±»å¯è¯»çš„é”™è¯¯æ¶ˆæ¯æ•°ç»„ã€‚æˆ‘ä»¬å¾ˆå¿«å°±ä¼šè®²åˆ° actionã€‚

å¦ä¸€ä¸ªç»„ä»¶æ˜¯æ ‡ç­¾è¾“å…¥ã€‚å®ƒåªæ˜¯ä¸€ä¸ªæ™®é€šçš„è¾“å…¥å­—æ®µï¼Œé™„å¸¦æ‰€é€‰æ ‡ç­¾çš„é¢å¤–é¢„è§ˆã€‚è¿™é‡Œæ²¡ä»€ä¹ˆå¯çœ‹çš„ï¼š

```tsx title="pages/article-edit/ui/TagsInput.tsx"
import { useEffect, useRef, useState } from "react";

export function TagsInput({
  name,
  defaultValue,
}: {
  name: string;
  defaultValue?: Array<string>;
}) {
  const [tagListState, setTagListState] = useState(defaultValue ?? []);

  function removeTag(tag: string): void {
    const newTagList = tagListState.filter((t) => t !== tag);
    setTagListState(newTagList);
  }

  const tagsInput = useRef<HTMLInputElement>(null);
  useEffect(() => {
    tagsInput.current && (tagsInput.current.value = tagListState.join(","));
  }, [tagListState]);

  return (
    <>
      <input
        type="text"
        className="form-control"
        id="tags"
        name={name}
        placeholder="Enter tags"
        defaultValue={tagListState.join(",")}
        onChange={(e) =>
          setTagListState(e.target.value.split(",").filter(Boolean))
        }
      />
      <div className="tag-list">
        {tagListState.map((tag) => (
          <span className="tag-default tag-pill" key={tag}>
            <i
              className="ion-close-round"
              role="button"
              tabIndex={0}
              onKeyDown={(e) =>
                [" ", "Enter"].includes(e.key) && removeTag(tag)
              }
              onClick={() => removeTag(tag)}
            ></i>{" "}
            {tag}
          </span>
        ))}
      </div>
    </>
  );
}
```

ç°åœ¨ï¼ŒAPI éƒ¨åˆ†ã€‚loader åº”è¯¥æŸ¥çœ‹ URLï¼Œå¦‚æœå®ƒåŒ…å«æ–‡ç«  slugï¼Œé‚£æ„å‘³ç€æˆ‘ä»¬æ­£åœ¨ç¼–è¾‘ç°æœ‰æ–‡ç« ï¼Œåº”è¯¥åŠ è½½å…¶æ•°æ®ã€‚å¦åˆ™ï¼Œè¿”å›ç©ºã€‚è®©æˆ‘ä»¬åˆ›å»ºè¯¥ loaderï¼š

```ts title="pages/article-edit/api/loader.ts"
import { json, type LoaderFunctionArgs } from "@remix-run/node";
import type { FetchResponse } from "openapi-fetch";

import { GET, requireUser } from "shared/api";

async function throwAnyErrors<T, O, Media extends `${string}/${string}`>(
  responsePromise: Promise<FetchResponse<T, O, Media>>,
) {
  const { data, error, response } = await responsePromise;

  if (error !== undefined) {
    throw json(error, { status: response.status });
  }

  return data as NonNullable<typeof data>;
}

export const loader = async ({ params, request }: LoaderFunctionArgs) => {
  const currentUser = await requireUser(request);

  if (!params.slug) {
    return { article: null };
  }

  return throwAnyErrors(
    GET("/articles/{slug}", {
      params: { path: { slug: params.slug } },
      headers: { Authorization: `Token ${currentUser.token}` },
    }),
  );
};
```

action å°†è·å–æ–°çš„å­—æ®µå€¼ï¼Œé€šè¿‡æˆ‘ä»¬çš„æ•°æ®æ¨¡å¼è¿è¡Œå®ƒä»¬ï¼Œå¦‚æœä¸€åˆ‡éƒ½æ­£ç¡®ï¼Œå°±å°†è¿™äº›æ›´æ”¹æäº¤åˆ°åç«¯ï¼Œé€šè¿‡æ›´æ–°ç°æœ‰æ–‡ç« æˆ–åˆ›å»ºæ–°æ–‡ç« ï¼š

```tsx title="pages/article-edit/api/action.ts"
import { json, redirect, type ActionFunctionArgs } from "@remix-run/node";

import { POST, PUT, requireUser } from "shared/api";
import { parseAsArticle } from "../model/parseAsArticle";

export const action = async ({ request, params }: ActionFunctionArgs) => {
  try {
    const { body, description, title, tags } = parseAsArticle(
      await request.formData(),
    );
    const tagList = tags?.split(",") ?? [];

    const currentUser = await requireUser(request);
    const payload = {
      body: {
        article: {
          title,
          description,
          body,
          tagList,
        },
      },
      headers: { Authorization: `Token ${currentUser.token}` },
    };

    const { data, error } = await (params.slug
      ? PUT("/articles/{slug}", {
          params: { path: { slug: params.slug } },
          ...payload,
        })
      : POST("/articles", payload));

    if (error) {
      return json({ errors: error }, { status: 422 });
    }

    return redirect(`/article/${data.article.slug ?? ""}`);
  } catch (errors) {
    return json({ errors }, { status: 400 });
  }
};
```

æ¨¡å¼åŒæ—¶ä½œä¸º `FormData` çš„è§£æå‡½æ•°ï¼Œè¿™ä½¿æˆ‘ä»¬å¯ä»¥æ–¹ä¾¿åœ°è·å–å¹²å‡€çš„å­—æ®µæˆ–åªæ˜¯æŠ›å‡ºé”™è¯¯åœ¨æœ«å°¾å¤„ç†ã€‚è¿™é‡Œæ˜¯è¯¥è§£æå‡½æ•°çš„æ ·å­ï¼š

```tsx title="pages/article-edit/model/parseAsArticle.ts"
export function parseAsArticle(data: FormData) {
  const errors = [];

  const title = data.get("title");
  if (typeof title !== "string" || title === "") {
    errors.push("Give this article a title");
  }

  const description = data.get("description");
  if (typeof description !== "string" || description === "") {
    errors.push("Describe what this article is about");
  }

  const body = data.get("body");
  if (typeof body !== "string" || body === "") {
    errors.push("Write the article itself");
  }

  const tags = data.get("tags");
  if (typeof tags !== "string") {
    errors.push("The tags must be a string");
  }

  if (errors.length > 0) {
    throw errors;
  }

  return { title, description, body, tags: data.get("tags") ?? "" } as {
    title: string;
    description: string;
    body: string;
    tags: string;
  };
}
```

å¯ä»¥è¯´ï¼Œå®ƒæœ‰ç‚¹å‡—é•¿å’Œé‡å¤ï¼Œä½†è¿™æ˜¯æˆ‘ä»¬ä¸ºäººç±»å¯è¯»é”™è¯¯ä»˜å‡ºçš„ä»£ä»·ã€‚è¿™ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ª Zod æ¨¡å¼ï¼Œä¾‹å¦‚ï¼Œä½†ç„¶åæˆ‘ä»¬å¿…é¡»åœ¨å‰ç«¯æ¸²æŸ“é”™è¯¯æ¶ˆæ¯ï¼Œè¿™ä¸ªè¡¨å•ä¸å€¼å¾—å¤æ‚åŒ–ã€‚

æœ€åä¸€æ­¥ â€” å°†é¡µé¢ã€loader å’Œ action è¿æ¥åˆ°è·¯ç”±ã€‚ç”±äºæˆ‘ä»¬å·§å¦™åœ°æ”¯æŒåˆ›å»ºå’Œç¼–è¾‘ï¼Œæˆ‘ä»¬å¯ä»¥ä» `editor._index.tsx` å’Œ `editor.$slug.tsx` ä¸¤è€…å¯¼å‡ºç›¸åŒçš„ä¸œè¥¿ï¼š

```tsx title="pages/article-edit/index.ts"
export { ArticleEditPage } from "./ui/ArticleEditPage";
export { loader } from "./api/loader";
export { action } from "./api/action";
```

```tsx title="app/routes/editor._index.tsx, app/routes/editor.$slug.tsx (same content)"
import { ArticleEditPage } from "pages/article-edit";

export { loader, action } from "pages/article-edit";

export default ArticleEditPage;
```

æˆ‘ä»¬ç°åœ¨å®Œæˆäº†ï¼ç™»å½•å¹¶å°è¯•åˆ›å»ºä¸€ç¯‡æ–°æ–‡ç« ã€‚æˆ–è€…â€œå¿˜è®°â€ç¼–å†™æ–‡ç« å¹¶çœ‹åˆ°éªŒè¯ç”Ÿæ•ˆã€‚

<figure>
  ![The Conduit article editor, with the title field saying â€œNew articleâ€ and the rest of the fields empty. Above the form there are two errors: â€œ**Describe what this article is aboutâ€ and â€œWrite the article itselfâ€.**](../../../../../../static/img/tutorial/realworld-article-editor.jpg)

  <figcaption>The Conduit article editor, with the title field saying â€œNew articleâ€ and the rest of the fields empty. Above the form there are two errors: **â€œDescribe what this article is aboutâ€** and **â€œWrite the article itselfâ€**.</figcaption>
</figure>

èµ„æ–™å’Œè®¾ç½®é¡µé¢ä¸æ–‡ç« é˜…è¯»å™¨å’Œç¼–è¾‘å™¨éå¸¸ç›¸ä¼¼ï¼Œå®ƒä»¬ç•™ä½œè¯»è€…çš„ç»ƒä¹ ï¼Œè¿™å°±æ˜¯æ‚¨ :)
